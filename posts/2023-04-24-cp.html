<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Madhav Kanda">
<meta name="dcterms.date" content="2023-04-25">
<meta name="description" content="Explaining Conformal Prediction">

<title>Blog - Conformal Prediction</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://madhav-kanda.github.io/" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Conformal Prediction</h1>
                  <div>
        <div class="description">
          Explaining Conformal Prediction
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Conformal Prediction</div>
                <div class="quarto-category">ML</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Madhav Kanda </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 25, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#conformal-prediction" id="toc-conformal-prediction" class="nav-link active" data-scroll-target="#conformal-prediction">Conformal Prediction</a>
  <ul class="collapse">
  <li><a href="#why-use-conformal-prediction" id="toc-why-use-conformal-prediction" class="nav-link" data-scroll-target="#why-use-conformal-prediction">Why use conformal prediction?</a></li>
  <li><a href="#aim" id="toc-aim" class="nav-link" data-scroll-target="#aim">Aim</a></li>
  <li><a href="#outline" id="toc-outline" class="nav-link" data-scroll-target="#outline">Outline</a></li>
  </ul></li>
  <li><a href="#details-of-the-method" id="toc-details-of-the-method" class="nav-link" data-scroll-target="#details-of-the-method">Details of the method</a>
  <ul class="collapse">
  <li><a href="#given" id="toc-given" class="nav-link" data-scroll-target="#given">Given</a></li>
  <li><a href="#goal" id="toc-goal" class="nav-link" data-scroll-target="#goal">Goal</a></li>
  <li><a href="#objective-for-the-sets" id="toc-objective-for-the-sets" class="nav-link" data-scroll-target="#objective-for-the-sets">Objective for the sets</a></li>
  <li><a href="#general-method-for-conformal-prediction" id="toc-general-method-for-conformal-prediction" class="nav-link" data-scroll-target="#general-method-for-conformal-prediction">General Method for Conformal Prediction</a></li>
  </ul></li>
  <li><a href="#implementing-classification-model-for-mnist-dataset" id="toc-implementing-classification-model-for-mnist-dataset" class="nav-link" data-scroll-target="#implementing-classification-model-for-mnist-dataset">Implementing classification model for MNIST dataset</a>
  <ul class="collapse">
  <li><a href="#now-lets-implement-conformal-prediction" id="toc-now-lets-implement-conformal-prediction" class="nav-link" data-scroll-target="#now-lets-implement-conformal-prediction"><em>Now Letsâ€™ implement conformal Prediction</em></a></li>
  <li><a href="#intuitive-understanding" id="toc-intuitive-understanding" class="nav-link" data-scroll-target="#intuitive-understanding"><em>Intuitive understanding</em></a></li>
  <li><a href="#implementing-conformal-prediction-using-the-general-method" id="toc-implementing-conformal-prediction-using-the-general-method" class="nav-link" data-scroll-target="#implementing-conformal-prediction-using-the-general-method"><em>Implementing conformal prediction using the General Method</em></a></li>
  <li><a href="#insights-and-summary" id="toc-insights-and-summary" class="nav-link" data-scroll-target="#insights-and-summary"><em>Insights and Summary:</em></a>
  <ul class="collapse">
  <li><a href="#implementation-using-imagenet" id="toc-implementation-using-imagenet" class="nav-link" data-scroll-target="#implementation-using-imagenet"><em>Implementation using Imagenet</em></a></li>
  </ul></li>
  <li><a href="#adaptive-prediction-sets" id="toc-adaptive-prediction-sets" class="nav-link" data-scroll-target="#adaptive-prediction-sets"><em>Adaptive Prediction Sets</em></a>
  <ul class="collapse">
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation"><em>Implementation</em></a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="conformal-prediction" class="level1">
<h1>Conformal Prediction</h1>
<section id="why-use-conformal-prediction" class="level2">
<h2 class="anchored" data-anchor-id="why-use-conformal-prediction">Why use conformal prediction?</h2>
<p><em>Guess the following images:</em></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2023-04-25-cp_files/figure-html/e8dddaa4-1-image.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">image.png</figcaption>
</figure>
</div>
<p><em>Prediction set generated by conformal prediction for the images:</em></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2023-04-25-cp_files/figure-html/b5b26fc6-1-image.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">image.png</figcaption>
</figure>
</div>
</section>
<section id="aim" class="level2">
<h2 class="anchored" data-anchor-id="aim">Aim</h2>
<p>Using conformal prediction we aim to generate rigorous, finite sample confidence intervals for any model and any dataset. Unlike a point prediction from neural network, here we will get a confidence interval in which desired output is guaranteed to be.</p>
</section>
<section id="outline" class="level2">
<h2 class="anchored" data-anchor-id="outline">Outline</h2>
<ol type="1">
<li>Begin with a fitted predicted model which we call <span class="math inline">\(\hat{f}\)</span>.</li>
<li>Create a predicted set (set of possible labels) for this model using a small amount of calibration data.</li>
</ol>
</section>
</section>
<section id="details-of-the-method" class="level1">
<h1>Details of the method</h1>
<hr>
<section id="given" class="level2">
<h2 class="anchored" data-anchor-id="given">Given</h2>
<ol type="1">
<li><p>A calibration dataset <span class="math inline">\(\{(x_i,y_i)\}_{i=1}^n\)</span> (This is the dataset that the model does not see during training).</p></li>
<li><p>A <span class="math inline">\(model\)</span> <span class="math inline">\(\hat{\pi}(x) = P[Y=y|X=x]\)</span></p></li>
<li><p>A <span class="math inline">\(new\)</span> <span class="math inline">\(data\)</span> <span class="math inline">\(point\)</span> <span class="math inline">\(x_{n+1}\)</span> to test the model</p></li>
</ol>
</section>
<section id="goal" class="level2">
<h2 class="anchored" data-anchor-id="goal">Goal</h2>
<p>Predict a set <span class="math inline">\(\tau(X_{test})\)</span> for the data point <span class="math inline">\(X_{test}\)</span> that is a subset of the label space <span class="math inline">\(i.e.\)</span> predict a set, <span class="math inline">\(\tau(X_{test}) \subseteq y\)</span>. This set should contain the true class <span class="math inline">\(Y_{test}\)</span> and should be valid in the following sense:</p>
<p>$ 1 - P[Y_{test} (X_{test})] - + $</p>
<p>here <span class="math inline">\(\alpha\)</span> is a user chosen rate in <span class="math inline">\(\in [0,1]\)</span>, <span class="math inline">\(y\)</span> is the set of all labels &amp; <span class="math inline">\(n\)</span> is the number of points in calibration dataset. The above mentioned property is called <em>Marginal Coverage</em>.</p>
</section>
<section id="objective-for-the-sets" class="level2">
<h2 class="anchored" data-anchor-id="objective-for-the-sets">Objective for the sets</h2>
<ol type="1">
<li><p>Exact coverage</p></li>
<li><p>Small size</p></li>
<li><p>Size of the set should indicate the difficulty of the examples <span class="math inline">\(i.e.\)</span> Adaptivity</p></li>
</ol>
</section>
<section id="general-method-for-conformal-prediction" class="level2">
<h2 class="anchored" data-anchor-id="general-method-for-conformal-prediction">General Method for Conformal Prediction</h2>
<ol type="1">
<li><p>Identify a heuristic notion of uncertainity</p></li>
<li><p>Define a score function <span class="math inline">\(S(x,y)\)</span> based on the values in step 1. In general large values of <span class="math inline">\(S\)</span> corresponds to a bad fit between <span class="math inline">\(x\)</span> <span class="math inline">\(\&amp;\)</span> <span class="math inline">\(y\)</span></p></li>
<li><p>Compute <span class="math inline">\(\hat{q} : \frac{\lceil{(n+1)(1-\alpha)}\rceil}{n}\)</span> quantile of <span class="math inline">\(S(x,y)\)</span> on calibration dataset</p></li>
<li><p>To obtain the prediction set: <span class="math inline">\(\tau(x) = \{y:S(x,y) \le \hat{q} \}\)</span></p></li>
</ol>
</section>
</section>
<section id="implementing-classification-model-for-mnist-dataset" class="level1">
<h1>Implementing classification model for MNIST dataset</h1>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.image <span class="im">import</span> imread</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install -U --no-cache-dir gdown --pre</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n_epochs <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>batch_size_train <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>batch_size_test <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>learning_rate <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>momentum <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>log_interval <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>random_seed <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>torch.backends.cudnn.enabled <span class="op">=</span> <span class="va">False</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(random_seed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>&lt;torch._C.Generator at 0x7f36391523f0&gt;</code></pre>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>train_loader <span class="op">=</span> torch.utils.data.DataLoader(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    torchvision.datasets.MNIST(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dataset/"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        train<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        download<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        transform<span class="op">=</span>torchvision.transforms.Compose(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                torchvision.transforms.ToTensor(),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                torchvision.transforms.Normalize((<span class="fl">0.1307</span>,), (<span class="fl">0.3081</span>,)),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size_train,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>full_test <span class="op">=</span> torchvision.datasets.MNIST(</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    root<span class="op">=</span><span class="st">"dataset/"</span>,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    train<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    download<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    transform<span class="op">=</span>torchvision.transforms.Compose(</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>            torchvision.transforms.ToTensor(),</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>            torchvision.transforms.Normalize((<span class="fl">0.1307</span>,), (<span class="fl">0.3081</span>,)),</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the number of samples in the full dataset</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>num_samples <span class="op">=</span> <span class="bu">len</span>(full_test)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the dataset into two parts: test set and calibration set</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>test_size <span class="op">=</span> num_samples <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>calibration_size <span class="op">=</span> num_samples <span class="op">-</span> test_size</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>test_dataset, calibration_dataset <span class="op">=</span> torch.utils.data.random_split(</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    full_test, [test_size, calibration_size]</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the test and calibration loaders</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>test_loader <span class="op">=</span> torch.utils.data.DataLoader(</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    test_dataset, batch_size<span class="op">=</span><span class="dv">5</span> <span class="op">*</span> batch_size_test, shuffle<span class="op">=</span><span class="va">True</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>calibration_loader <span class="op">=</span> torch.utils.data.DataLoader(</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    calibration_dataset, batch_size<span class="op">=</span><span class="dv">5</span> <span class="op">*</span> batch_size_test, shuffle<span class="op">=</span><span class="va">True</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>target_values <span class="op">=</span> []</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> input_data, targets <span class="kw">in</span> train_loader:</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    target_values.extend(targets.tolist())</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>target_values <span class="op">=</span> np.array(target_values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ax.hist(target_values, color<span class="op">=</span><span class="st">"skyblue"</span>, edgecolor<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">1.2</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Target values"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Histogram of Target values for Training set"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> <span class="bu">enumerate</span>(test_loader)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>batch_idx, (example_data, example_targets) <span class="op">=</span> <span class="bu">next</span>(examples)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(batch_idx)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">6</span>):</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">3</span>, i <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    plt.imshow(example_data[i][<span class="dv">0</span>], cmap<span class="op">=</span><span class="st">"gray"</span>, interpolation<span class="op">=</span><span class="st">"none"</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"Ground Truth: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(example_targets[i]))</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    plt.xticks([])</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    plt.yticks([])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-7-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Net(nn.Module):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Net, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv1 <span class="op">=</span> nn.Conv2d(<span class="dv">1</span>, <span class="dv">10</span>, kernel_size<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv2 <span class="op">=</span> nn.Conv2d(<span class="dv">10</span>, <span class="dv">20</span>, kernel_size<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv2_drop <span class="op">=</span> nn.Dropout2d()</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc1 <span class="op">=</span> nn.Linear(<span class="dv">320</span>, <span class="dv">50</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc2 <span class="op">=</span> nn.Linear(<span class="dv">50</span>, <span class="dv">10</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> F.relu(F.max_pool2d(<span class="va">self</span>.conv1(x), <span class="dv">2</span>))</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> F.relu(F.max_pool2d(<span class="va">self</span>.conv2_drop(<span class="va">self</span>.conv2(x)), <span class="dv">2</span>))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x.view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">320</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> F.relu(<span class="va">self</span>.fc1(x))</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> F.dropout(x, training<span class="op">=</span><span class="va">self</span>.training)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.fc2(x)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> F.softmax(x, dim<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>network <span class="op">=</span> Net()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> optim.SGD(network.parameters(), lr<span class="op">=</span>learning_rate, momentum<span class="op">=</span>momentum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>train_losses <span class="op">=</span> []</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>train_counter <span class="op">=</span> []</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>test_losses <span class="op">=</span> []</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>test_counter <span class="op">=</span> []</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> nn.CrossEntropyLoss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(epoch):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    network.train()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch_idx, (data, target) <span class="kw">in</span> <span class="bu">enumerate</span>(train_loader):</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> network(data)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> F.nll_loss(output, target)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> batch_idx <span class="op">%</span> log_interval <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Train Epoch: </span><span class="sc">{}</span><span class="st"> [</span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st"> (</span><span class="sc">{:.0f}</span><span class="st">%)]</span><span class="ch">\t</span><span class="st">Loss: </span><span class="sc">{:.6f}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>                    epoch,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>                    batch_idx <span class="op">*</span> <span class="bu">len</span>(data),</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">len</span>(train_loader.dataset),</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">100.0</span> <span class="op">*</span> batch_idx <span class="op">/</span> <span class="bu">len</span>(train_loader),</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>                    loss.item(),</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># train_losses.append(loss.item())</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>            <span class="co"># train_counter.append(</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">#   (batch_idx*64) + ((epoch-1)*len(train_loader.dataset)))</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>            torch.save(network.state_dict(), <span class="st">"results/model.pth"</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>            torch.save(optimizer.state_dict(), <span class="st">"results/optimizer.pth"</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    train_losses.append(loss.item())</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    train_counter.append(epoch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test(epoch):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    network.<span class="bu">eval</span>()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    test_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> data, target <span class="kw">in</span> test_loader:</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>            output <span class="op">=</span> network(data)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>            test_loss <span class="op">+=</span> F.nll_loss(output, target, reduction<span class="op">=</span><span class="st">"sum"</span>).item()</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>            pred <span class="op">=</span> output.data.<span class="bu">max</span>(<span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>]</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>            correct <span class="op">+=</span> pred.eq(target.data.view_as(pred)).<span class="bu">sum</span>()</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    test_loss <span class="op">/=</span> <span class="bu">len</span>(test_loader.dataset)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    test_losses.append(test_loss)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    test_counter.append(epoch)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"</span><span class="ch">\n</span><span class="st">Test set: Avg. loss: </span><span class="sc">{:.4f}</span><span class="st">, Accuracy: </span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st"> (</span><span class="sc">{:.0f}</span><span class="st">%)</span><span class="ch">\n</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>            test_loss,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>            correct,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">len</span>(test_loader.dataset),</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>            <span class="fl">100.0</span> <span class="op">*</span> correct <span class="op">/</span> <span class="bu">len</span>(test_loader.dataset),</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_epochs <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    train(epoch)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    test(epoch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train Epoch: 1 [0/60000 (0%)]   Loss: -0.096270
Train Epoch: 1 [640/60000 (1%)] Loss: -0.101968
Train Epoch: 1 [1280/60000 (2%)]    Loss: -0.094875
Train Epoch: 1 [1920/60000 (3%)]    Loss: -0.096943
Train Epoch: 1 [2560/60000 (4%)]    Loss: -0.100370
Train Epoch: 1 [3200/60000 (5%)]    Loss: -0.106169
Train Epoch: 1 [3840/60000 (6%)]    Loss: -0.095606
Train Epoch: 1 [4480/60000 (7%)]    Loss: -0.100021
Train Epoch: 1 [5120/60000 (9%)]    Loss: -0.097964
Train Epoch: 1 [5760/60000 (10%)]   Loss: -0.105364
Train Epoch: 1 [6400/60000 (11%)]   Loss: -0.099801
Train Epoch: 1 [7040/60000 (12%)]   Loss: -0.104224
Train Epoch: 1 [7680/60000 (13%)]   Loss: -0.102671
Train Epoch: 1 [8320/60000 (14%)]   Loss: -0.102677
Train Epoch: 1 [8960/60000 (15%)]   Loss: -0.098862
Train Epoch: 1 [9600/60000 (16%)]   Loss: -0.104594
Train Epoch: 1 [10240/60000 (17%)]  Loss: -0.107961
Train Epoch: 1 [10880/60000 (18%)]  Loss: -0.101030
Train Epoch: 1 [11520/60000 (19%)]  Loss: -0.106397
Train Epoch: 1 [12160/60000 (20%)]  Loss: -0.105689
Train Epoch: 1 [12800/60000 (21%)]  Loss: -0.101100
Train Epoch: 1 [13440/60000 (22%)]  Loss: -0.099717
Train Epoch: 1 [14080/60000 (23%)]  Loss: -0.110008
Train Epoch: 1 [14720/60000 (25%)]  Loss: -0.107806
Train Epoch: 1 [15360/60000 (26%)]  Loss: -0.106625
Train Epoch: 1 [16000/60000 (27%)]  Loss: -0.104545
Train Epoch: 1 [16640/60000 (28%)]  Loss: -0.110616
Train Epoch: 1 [17280/60000 (29%)]  Loss: -0.108283
Train Epoch: 1 [17920/60000 (30%)]  Loss: -0.108704
Train Epoch: 1 [18560/60000 (31%)]  Loss: -0.114978
Train Epoch: 1 [19200/60000 (32%)]  Loss: -0.118148
Train Epoch: 1 [19840/60000 (33%)]  Loss: -0.119028
Train Epoch: 1 [20480/60000 (34%)]  Loss: -0.116415
Train Epoch: 1 [21120/60000 (35%)]  Loss: -0.116105
Train Epoch: 1 [21760/60000 (36%)]  Loss: -0.118710
Train Epoch: 1 [22400/60000 (37%)]  Loss: -0.121168
Train Epoch: 1 [23040/60000 (38%)]  Loss: -0.123993
Train Epoch: 1 [23680/60000 (39%)]  Loss: -0.115344
Train Epoch: 1 [24320/60000 (41%)]  Loss: -0.124260
Train Epoch: 1 [24960/60000 (42%)]  Loss: -0.109251
Train Epoch: 1 [25600/60000 (43%)]  Loss: -0.130309
Train Epoch: 1 [26240/60000 (44%)]  Loss: -0.113852
Train Epoch: 1 [26880/60000 (45%)]  Loss: -0.135410
Train Epoch: 1 [27520/60000 (46%)]  Loss: -0.123541
Train Epoch: 1 [28160/60000 (47%)]  Loss: -0.138047
Train Epoch: 1 [28800/60000 (48%)]  Loss: -0.171173
Train Epoch: 1 [29440/60000 (49%)]  Loss: -0.141748
Train Epoch: 1 [30080/60000 (50%)]  Loss: -0.136376
Train Epoch: 1 [30720/60000 (51%)]  Loss: -0.167414
Train Epoch: 1 [31360/60000 (52%)]  Loss: -0.209505
Train Epoch: 1 [32000/60000 (53%)]  Loss: -0.170585
Train Epoch: 1 [32640/60000 (54%)]  Loss: -0.152469
Train Epoch: 1 [33280/60000 (55%)]  Loss: -0.183759
Train Epoch: 1 [33920/60000 (57%)]  Loss: -0.205033
Train Epoch: 1 [34560/60000 (58%)]  Loss: -0.190846
Train Epoch: 1 [35200/60000 (59%)]  Loss: -0.203513
Train Epoch: 1 [35840/60000 (60%)]  Loss: -0.193385
Train Epoch: 1 [36480/60000 (61%)]  Loss: -0.236351
Train Epoch: 1 [37120/60000 (62%)]  Loss: -0.300120
Train Epoch: 1 [37760/60000 (63%)]  Loss: -0.258446
Train Epoch: 1 [38400/60000 (64%)]  Loss: -0.298882
Train Epoch: 1 [39040/60000 (65%)]  Loss: -0.224463
Train Epoch: 1 [39680/60000 (66%)]  Loss: -0.239283
Train Epoch: 1 [40320/60000 (67%)]  Loss: -0.320215
Train Epoch: 1 [40960/60000 (68%)]  Loss: -0.271330
Train Epoch: 1 [41600/60000 (69%)]  Loss: -0.218053
Train Epoch: 1 [42240/60000 (70%)]  Loss: -0.336276
Train Epoch: 1 [42880/60000 (71%)]  Loss: -0.423247
Train Epoch: 1 [43520/60000 (72%)]  Loss: -0.340593
Train Epoch: 1 [44160/60000 (74%)]  Loss: -0.349698
Train Epoch: 1 [44800/60000 (75%)]  Loss: -0.343172
Train Epoch: 1 [45440/60000 (76%)]  Loss: -0.365741
Train Epoch: 1 [46080/60000 (77%)]  Loss: -0.336732
Train Epoch: 1 [46720/60000 (78%)]  Loss: -0.356187
Train Epoch: 1 [47360/60000 (79%)]  Loss: -0.365025
Train Epoch: 1 [48000/60000 (80%)]  Loss: -0.285388
Train Epoch: 1 [48640/60000 (81%)]  Loss: -0.404647
Train Epoch: 1 [49280/60000 (82%)]  Loss: -0.481464
Train Epoch: 1 [49920/60000 (83%)]  Loss: -0.454246
Train Epoch: 1 [50560/60000 (84%)]  Loss: -0.461179
Train Epoch: 1 [51200/60000 (85%)]  Loss: -0.424522
Train Epoch: 1 [51840/60000 (86%)]  Loss: -0.476232
Train Epoch: 1 [52480/60000 (87%)]  Loss: -0.483999
Train Epoch: 1 [53120/60000 (88%)]  Loss: -0.512280
Train Epoch: 1 [53760/60000 (90%)]  Loss: -0.485575
Train Epoch: 1 [54400/60000 (91%)]  Loss: -0.550330
Train Epoch: 1 [55040/60000 (92%)]  Loss: -0.507828
Train Epoch: 1 [55680/60000 (93%)]  Loss: -0.408248
Train Epoch: 1 [56320/60000 (94%)]  Loss: -0.482777
Train Epoch: 1 [56960/60000 (95%)]  Loss: -0.490255
Train Epoch: 1 [57600/60000 (96%)]  Loss: -0.510454
Train Epoch: 1 [58240/60000 (97%)]  Loss: -0.533454
Train Epoch: 1 [58880/60000 (98%)]  Loss: -0.451538
Train Epoch: 1 [59520/60000 (99%)]  Loss: -0.503178

Test set: Avg. loss: -0.6431, Accuracy: 3458/5000 (69%)

Train Epoch: 2 [0/60000 (0%)]   Loss: -0.543103
Train Epoch: 2 [640/60000 (1%)] Loss: -0.487201
Train Epoch: 2 [1280/60000 (2%)]    Loss: -0.560745
Train Epoch: 2 [1920/60000 (3%)]    Loss: -0.614560
Train Epoch: 2 [2560/60000 (4%)]    Loss: -0.481817
Train Epoch: 2 [3200/60000 (5%)]    Loss: -0.541968
Train Epoch: 2 [3840/60000 (6%)]    Loss: -0.563525
Train Epoch: 2 [4480/60000 (7%)]    Loss: -0.610633
Train Epoch: 2 [5120/60000 (9%)]    Loss: -0.512815
Train Epoch: 2 [5760/60000 (10%)]   Loss: -0.526713
Train Epoch: 2 [6400/60000 (11%)]   Loss: -0.602760
Train Epoch: 2 [7040/60000 (12%)]   Loss: -0.576782
Train Epoch: 2 [7680/60000 (13%)]   Loss: -0.621671
Train Epoch: 2 [8320/60000 (14%)]   Loss: -0.559132
Train Epoch: 2 [8960/60000 (15%)]   Loss: -0.628107
Train Epoch: 2 [9600/60000 (16%)]   Loss: -0.512339
Train Epoch: 2 [10240/60000 (17%)]  Loss: -0.566718
Train Epoch: 2 [10880/60000 (18%)]  Loss: -0.511051
Train Epoch: 2 [11520/60000 (19%)]  Loss: -0.647878
Train Epoch: 2 [12160/60000 (20%)]  Loss: -0.557889
Train Epoch: 2 [12800/60000 (21%)]  Loss: -0.519488
Train Epoch: 2 [13440/60000 (22%)]  Loss: -0.590033
Train Epoch: 2 [14080/60000 (23%)]  Loss: -0.649739
Train Epoch: 2 [14720/60000 (25%)]  Loss: -0.620025
Train Epoch: 2 [15360/60000 (26%)]  Loss: -0.593018
Train Epoch: 2 [16000/60000 (27%)]  Loss: -0.595310
Train Epoch: 2 [16640/60000 (28%)]  Loss: -0.616386
Train Epoch: 2 [17280/60000 (29%)]  Loss: -0.613914
Train Epoch: 2 [17920/60000 (30%)]  Loss: -0.654145
Train Epoch: 2 [18560/60000 (31%)]  Loss: -0.738744
Train Epoch: 2 [19200/60000 (32%)]  Loss: -0.643044
Train Epoch: 2 [19840/60000 (33%)]  Loss: -0.649137
Train Epoch: 2 [20480/60000 (34%)]  Loss: -0.692642
Train Epoch: 2 [21120/60000 (35%)]  Loss: -0.633675
Train Epoch: 2 [21760/60000 (36%)]  Loss: -0.687573
Train Epoch: 2 [22400/60000 (37%)]  Loss: -0.701991
Train Epoch: 2 [23040/60000 (38%)]  Loss: -0.645086
Train Epoch: 2 [23680/60000 (39%)]  Loss: -0.692898
Train Epoch: 2 [24320/60000 (41%)]  Loss: -0.577617
Train Epoch: 2 [24960/60000 (42%)]  Loss: -0.683858
Train Epoch: 2 [25600/60000 (43%)]  Loss: -0.683304
Train Epoch: 2 [26240/60000 (44%)]  Loss: -0.557712
Train Epoch: 2 [26880/60000 (45%)]  Loss: -0.641402
Train Epoch: 2 [27520/60000 (46%)]  Loss: -0.574060
Train Epoch: 2 [28160/60000 (47%)]  Loss: -0.618113
Train Epoch: 2 [28800/60000 (48%)]  Loss: -0.625470
Train Epoch: 2 [29440/60000 (49%)]  Loss: -0.632310
Train Epoch: 2 [30080/60000 (50%)]  Loss: -0.784766
Train Epoch: 2 [30720/60000 (51%)]  Loss: -0.694353
Train Epoch: 2 [31360/60000 (52%)]  Loss: -0.620910
Train Epoch: 2 [32000/60000 (53%)]  Loss: -0.655771
Train Epoch: 2 [32640/60000 (54%)]  Loss: -0.673174
Train Epoch: 2 [33280/60000 (55%)]  Loss: -0.736954
Train Epoch: 2 [33920/60000 (57%)]  Loss: -0.608999
Train Epoch: 2 [34560/60000 (58%)]  Loss: -0.655900
Train Epoch: 2 [35200/60000 (59%)]  Loss: -0.704720
Train Epoch: 2 [35840/60000 (60%)]  Loss: -0.788156
Train Epoch: 2 [36480/60000 (61%)]  Loss: -0.608460
Train Epoch: 2 [37120/60000 (62%)]  Loss: -0.683782
Train Epoch: 2 [37760/60000 (63%)]  Loss: -0.653793
Train Epoch: 2 [38400/60000 (64%)]  Loss: -0.651975
Train Epoch: 2 [39040/60000 (65%)]  Loss: -0.591193
Train Epoch: 2 [39680/60000 (66%)]  Loss: -0.620627
Train Epoch: 2 [40320/60000 (67%)]  Loss: -0.690345
Train Epoch: 2 [40960/60000 (68%)]  Loss: -0.677097
Train Epoch: 2 [41600/60000 (69%)]  Loss: -0.784562
Train Epoch: 2 [42240/60000 (70%)]  Loss: -0.723095
Train Epoch: 2 [42880/60000 (71%)]  Loss: -0.725503
Train Epoch: 2 [43520/60000 (72%)]  Loss: -0.699448
Train Epoch: 2 [44160/60000 (74%)]  Loss: -0.669538
Train Epoch: 2 [44800/60000 (75%)]  Loss: -0.693109
Train Epoch: 2 [45440/60000 (76%)]  Loss: -0.741334
Train Epoch: 2 [46080/60000 (77%)]  Loss: -0.571799
Train Epoch: 2 [46720/60000 (78%)]  Loss: -0.716431
Train Epoch: 2 [47360/60000 (79%)]  Loss: -0.754320
Train Epoch: 2 [48000/60000 (80%)]  Loss: -0.678586
Train Epoch: 2 [48640/60000 (81%)]  Loss: -0.689286
Train Epoch: 2 [49280/60000 (82%)]  Loss: -0.685702
Train Epoch: 2 [49920/60000 (83%)]  Loss: -0.721305
Train Epoch: 2 [50560/60000 (84%)]  Loss: -0.697595
Train Epoch: 2 [51200/60000 (85%)]  Loss: -0.702736
Train Epoch: 2 [51840/60000 (86%)]  Loss: -0.670738
Train Epoch: 2 [52480/60000 (87%)]  Loss: -0.723802
Train Epoch: 2 [53120/60000 (88%)]  Loss: -0.799761
Train Epoch: 2 [53760/60000 (90%)]  Loss: -0.741606
Train Epoch: 2 [54400/60000 (91%)]  Loss: -0.786890
Train Epoch: 2 [55040/60000 (92%)]  Loss: -0.647488
Train Epoch: 2 [55680/60000 (93%)]  Loss: -0.696402
Train Epoch: 2 [56320/60000 (94%)]  Loss: -0.749985
Train Epoch: 2 [56960/60000 (95%)]  Loss: -0.687131
Train Epoch: 2 [57600/60000 (96%)]  Loss: -0.608526
Train Epoch: 2 [58240/60000 (97%)]  Loss: -0.721615
Train Epoch: 2 [58880/60000 (98%)]  Loss: -0.797107
Train Epoch: 2 [59520/60000 (99%)]  Loss: -0.692595

Test set: Avg. loss: -0.8125, Accuracy: 4096/5000 (82%)
</code></pre>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(test_counter), <span class="bu">len</span>(test_losses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>(2, 2)</code></pre>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>plt.plot(train_counter, np.exp(train_losses), color<span class="op">=</span><span class="st">"blue"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>plt.plot(test_counter, np.exp(test_losses), color<span class="op">=</span><span class="st">"red"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train Loss"</span>, <span class="st">"Test Loss"</span>], loc<span class="op">=</span><span class="st">"upper right"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"epochs"</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Loss"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>Text(0, 0.5, 'Loss')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-16-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> network(example_data)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">6</span>):</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">3</span>, i <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    plt.imshow(example_data[i][<span class="dv">0</span>], cmap<span class="op">=</span><span class="st">"gray"</span>, interpolation<span class="op">=</span><span class="st">"none"</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"Prediction: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(output.data.<span class="bu">max</span>(<span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>)[<span class="dv">1</span>][i].item()))</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    plt.xticks([])</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    plt.yticks([])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>calib_prediction_results <span class="op">=</span> np.array([])</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>calib_target_results <span class="op">=</span> np.array([])</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>network.<span class="bu">eval</span>()</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> data, target <span class="kw">in</span> calibration_loader:</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> network(data)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    calib_prediction_results <span class="op">=</span> output.data</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    calib_target_results <span class="op">=</span> target.data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>test_prediction_results <span class="op">=</span> np.array([])</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>test_target_results <span class="op">=</span> np.array([])</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>test_images <span class="op">=</span> np.array([])</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>network.<span class="bu">eval</span>()</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> data, target <span class="kw">in</span> test_loader:</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> network(data)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    test_images <span class="op">=</span> data</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    test_prediction_results <span class="op">=</span> output.data</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    test_target_results <span class="op">=</span> target.data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="now-lets-implement-conformal-prediction" class="level2">
<h2 class="anchored" data-anchor-id="now-lets-implement-conformal-prediction"><em>Now Letsâ€™ implement conformal Prediction</em></h2>
<p><strong>A simpler version of the conformal prediction</strong></p>
<ol type="1">
<li><p>Compute <span class="math inline">\(\hat{q} : \alpha\)</span> quantile of <span class="math inline">\(S(x,y)\)</span> on calibration dataset where <span class="math inline">\(S(x,y)\)</span> is the score function correspoding to the true label</p></li>
<li><p>To obtain the prediction set: <span class="math inline">\(\tau(x) = \{y:S(x,y) \ge \hat{q} \}\)</span></p></li>
</ol>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>calib_target_results <span class="op">=</span> np.array(calib_target_results)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>calib_prediction_results <span class="op">=</span> np.array(calib_prediction_results)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>test_prediction_results <span class="op">=</span> np.array(test_prediction_results)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>test_target_results <span class="op">=</span> np.array(test_target_results)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>calib_prediction_results.shape, calib_target_results.shape, test_prediction_results.shape, test_target_results.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>((5000, 10), (5000,), (5000, 10), (5000,))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>calib_df <span class="op">=</span> pd.DataFrame(calib_prediction_results)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>calib_df[<span class="st">"Max"</span>] <span class="op">=</span> calib_df.<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>calib_df[<span class="st">"Max_idx"</span>] <span class="op">=</span> calib_df.idxmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>calib_df[<span class="st">"True_idx"</span>] <span class="op">=</span> calib_target_results</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>calib_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">Max</th>
<th data-quarto-table-cell-role="th">Max_idx</th>
<th data-quarto-table-cell-role="th">True_idx</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>7.672552e-08</td>
<td>5.311417e-07</td>
<td>1.562821e-04</td>
<td>3.211690e-09</td>
<td>4.822823e-04</td>
<td>2.262360e-06</td>
<td>9.993560e-01</td>
<td>3.220139e-11</td>
<td>1.609646e-06</td>
<td>9.680530e-07</td>
<td>0.999356</td>
<td>6</td>
<td>6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>7.041307e-08</td>
<td>1.779545e-07</td>
<td>6.658971e-06</td>
<td>4.084817e-07</td>
<td>6.008969e-08</td>
<td>1.122653e-08</td>
<td>1.417746e-04</td>
<td>1.310595e-09</td>
<td>9.998498e-01</td>
<td>9.002325e-07</td>
<td>0.999850</td>
<td>8</td>
<td>8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1.891271e-06</td>
<td>7.539936e-07</td>
<td>8.252732e-06</td>
<td>7.875642e-05</td>
<td>6.665982e-01</td>
<td>2.489255e-06</td>
<td>7.079141e-04</td>
<td>4.619782e-05</td>
<td>3.568919e-02</td>
<td>2.968663e-01</td>
<td>0.666598</td>
<td>4</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3.600329e-08</td>
<td>4.196039e-09</td>
<td>4.928238e-06</td>
<td>3.145105e-09</td>
<td>9.909703e-01</td>
<td>3.594812e-08</td>
<td>2.783901e-05</td>
<td>7.394720e-06</td>
<td>8.526304e-07</td>
<td>8.988610e-03</td>
<td>0.990970</td>
<td>4</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>8.007726e-06</td>
<td>8.686094e-05</td>
<td>1.262506e-04</td>
<td>9.905047e-01</td>
<td>2.181237e-07</td>
<td>3.404921e-07</td>
<td>8.625836e-06</td>
<td>2.125504e-06</td>
<td>9.200612e-03</td>
<td>6.224329e-05</td>
<td>0.990505</td>
<td>3</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4995</td>
<td>3.017699e-06</td>
<td>8.860756e-05</td>
<td>3.417503e-04</td>
<td>9.827271e-01</td>
<td>5.802370e-05</td>
<td>1.595727e-06</td>
<td>2.064353e-04</td>
<td>2.161075e-06</td>
<td>1.435820e-02</td>
<td>2.213240e-03</td>
<td>0.982727</td>
<td>3</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4996</td>
<td>5.440750e-13</td>
<td>9.999996e-01</td>
<td>7.675386e-08</td>
<td>5.033297e-11</td>
<td>2.031701e-11</td>
<td>4.493560e-11</td>
<td>7.547337e-10</td>
<td>3.736634e-08</td>
<td>2.838881e-07</td>
<td>3.246134e-12</td>
<td>1.000000</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4997</td>
<td>5.372684e-09</td>
<td>3.440873e-09</td>
<td>1.484947e-07</td>
<td>9.999758e-01</td>
<td>2.131953e-12</td>
<td>4.374669e-11</td>
<td>2.115596e-12</td>
<td>2.734103e-06</td>
<td>2.123476e-05</td>
<td>9.234377e-08</td>
<td>0.999976</td>
<td>3</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4998</td>
<td>1.966202e-07</td>
<td>6.421658e-07</td>
<td>5.014269e-05</td>
<td>2.109797e-09</td>
<td>2.172950e-05</td>
<td>5.110368e-07</td>
<td>9.999149e-01</td>
<td>3.196222e-10</td>
<td>3.617991e-06</td>
<td>8.205562e-06</td>
<td>0.999915</td>
<td>6</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4999</td>
<td>2.777072e-14</td>
<td>1.000000e+00</td>
<td>1.977435e-08</td>
<td>3.481474e-11</td>
<td>2.748897e-12</td>
<td>9.301366e-12</td>
<td>5.802548e-11</td>
<td>3.565957e-08</td>
<td>2.786610e-08</td>
<td>1.873916e-12</td>
<td>1.000000</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>5000 rows Ã— 13 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.DataFrame(test_prediction_results)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">"Max"</span>] <span class="op">=</span> test_df.<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">"Max_idx"</span>] <span class="op">=</span> test_df.idxmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">"True_idx"</span>] <span class="op">=</span> test_target_results</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>test_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">Max</th>
<th data-quarto-table-cell-role="th">Max_idx</th>
<th data-quarto-table-cell-role="th">True_idx</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1.507169e-09</td>
<td>6.793355e-10</td>
<td>9.392306e-10</td>
<td>3.272889e-09</td>
<td>4.279739e-09</td>
<td>1.000421e-10</td>
<td>7.060916e-13</td>
<td>9.973305e-01</td>
<td>3.673427e-07</td>
<td>2.669133e-03</td>
<td>0.997331</td>
<td>7</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1.528662e-08</td>
<td>4.265159e-12</td>
<td>3.008223e-05</td>
<td>9.999698e-01</td>
<td>1.717640e-15</td>
<td>2.861857e-14</td>
<td>1.901743e-12</td>
<td>4.749006e-13</td>
<td>8.433129e-08</td>
<td>6.817440e-14</td>
<td>0.999970</td>
<td>3</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1.440134e-10</td>
<td>3.157558e-06</td>
<td>2.407116e-05</td>
<td>5.108404e-11</td>
<td>5.610714e-07</td>
<td>1.101829e-08</td>
<td>9.999588e-01</td>
<td>4.209422e-15</td>
<td>1.334558e-05</td>
<td>3.933881e-10</td>
<td>0.999959</td>
<td>6</td>
<td>6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6.468001e-12</td>
<td>9.999986e-01</td>
<td>3.110969e-07</td>
<td>3.365797e-09</td>
<td>3.275069e-11</td>
<td>3.477734e-10</td>
<td>1.458348e-08</td>
<td>3.999051e-08</td>
<td>1.144535e-06</td>
<td>1.596769e-10</td>
<td>0.999999</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>8.815193e-05</td>
<td>6.341890e-03</td>
<td>8.312734e-04</td>
<td>1.951014e-04</td>
<td>1.125594e-02</td>
<td>2.372148e-04</td>
<td>7.425601e-03</td>
<td>1.311864e-03</td>
<td>1.279543e-02</td>
<td>9.595175e-01</td>
<td>0.959518</td>
<td>9</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4995</td>
<td>2.418953e-08</td>
<td>7.203251e-08</td>
<td>1.530548e-07</td>
<td>2.897828e-06</td>
<td>5.851566e-07</td>
<td>6.657368e-09</td>
<td>3.703725e-08</td>
<td>6.012499e-05</td>
<td>9.920814e-01</td>
<td>7.854681e-03</td>
<td>0.992081</td>
<td>8</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4996</td>
<td>4.415281e-09</td>
<td>1.504091e-08</td>
<td>2.217878e-06</td>
<td>9.999076e-01</td>
<td>1.170547e-09</td>
<td>1.767450e-10</td>
<td>1.133458e-08</td>
<td>1.103373e-09</td>
<td>8.993938e-05</td>
<td>2.646218e-07</td>
<td>0.999908</td>
<td>3</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4997</td>
<td>1.863301e-18</td>
<td>3.640452e-17</td>
<td>5.301770e-13</td>
<td>5.253428e-15</td>
<td>9.999909e-01</td>
<td>7.949940e-15</td>
<td>1.362663e-11</td>
<td>6.954227e-13</td>
<td>6.574446e-12</td>
<td>9.051804e-06</td>
<td>0.999991</td>
<td>4</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4998</td>
<td>6.859559e-17</td>
<td>7.214033e-16</td>
<td>3.279532e-11</td>
<td>1.938939e-14</td>
<td>9.999964e-01</td>
<td>1.438514e-13</td>
<td>1.612270e-10</td>
<td>2.956339e-12</td>
<td>7.959585e-12</td>
<td>3.579523e-06</td>
<td>0.999996</td>
<td>4</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4999</td>
<td>2.643393e-01</td>
<td>7.046102e-07</td>
<td>1.252546e-02</td>
<td>5.733218e-01</td>
<td>1.109647e-07</td>
<td>3.844558e-07</td>
<td>2.375773e-02</td>
<td>1.729390e-07</td>
<td>1.260542e-01</td>
<td>1.263923e-07</td>
<td>0.573322</td>
<td>3</td>
<td>5</td>
</tr>
</tbody>
</table>

<p>5000 rows Ã— 13 columns</p>
</div>
</div>
</div>
</section>
<section id="intuitive-understanding" class="level2">
<h2 class="anchored" data-anchor-id="intuitive-understanding"><em>Intuitive understanding</em></h2>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>stds_cal <span class="op">=</span> np.std(calib_prediction_results, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>min_std_indices_cal <span class="op">=</span> np.argsort(stds_cal)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>Sorting based on std deviation in the rows</em></p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>calib_df_std <span class="op">=</span> calib_df.loc[min_std_indices_cal]</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>calib_df_std</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">Max</th>
<th data-quarto-table-cell-role="th">Max_idx</th>
<th data-quarto-table-cell-role="th">True_idx</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">4792</td>
<td>2.204627e-01</td>
<td>1.263805e-02</td>
<td>1.064651e-01</td>
<td>2.497595e-02</td>
<td>3.831481e-02</td>
<td>1.915999e-02</td>
<td>2.428759e-01</td>
<td>4.884591e-02</td>
<td>2.138946e-01</td>
<td>7.236703e-02</td>
<td>0.242876</td>
<td>6</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3635</td>
<td>3.720535e-03</td>
<td>3.984575e-02</td>
<td>6.415164e-02</td>
<td>8.764555e-02</td>
<td>3.574266e-01</td>
<td>1.044143e-02</td>
<td>2.420991e-02</td>
<td>2.146130e-01</td>
<td>4.631169e-02</td>
<td>1.516339e-01</td>
<td>0.357427</td>
<td>4</td>
<td>6</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1115</td>
<td>1.880663e-02</td>
<td>2.226060e-01</td>
<td>8.889224e-02</td>
<td>6.196426e-02</td>
<td>1.060972e-02</td>
<td>5.382521e-03</td>
<td>2.736638e-01</td>
<td>7.305532e-03</td>
<td>2.858033e-01</td>
<td>2.496605e-02</td>
<td>0.285803</td>
<td>8</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1031</td>
<td>1.033852e-01</td>
<td>5.177050e-02</td>
<td>7.211524e-02</td>
<td>1.307259e-01</td>
<td>8.214290e-03</td>
<td>5.626875e-03</td>
<td>2.568235e-01</td>
<td>5.283331e-03</td>
<td>3.498454e-01</td>
<td>1.620973e-02</td>
<td>0.349845</td>
<td>8</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1778</td>
<td>7.243351e-02</td>
<td>5.959544e-05</td>
<td>1.995622e-01</td>
<td>1.425000e-05</td>
<td>2.422987e-01</td>
<td>4.558027e-04</td>
<td>1.450675e-01</td>
<td>8.497129e-03</td>
<td>4.330557e-04</td>
<td>3.311783e-01</td>
<td>0.331178</td>
<td>9</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2909</td>
<td>1.735541e-15</td>
<td>2.001958e-12</td>
<td>8.669379e-16</td>
<td>1.821178e-15</td>
<td>2.716592e-15</td>
<td>2.300831e-16</td>
<td>2.615356e-20</td>
<td>1.000000e+00</td>
<td>8.539057e-13</td>
<td>3.396687e-09</td>
<td>1.000000</td>
<td>7</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2914</td>
<td>1.000000e+00</td>
<td>5.918221e-19</td>
<td>1.986233e-10</td>
<td>1.237661e-14</td>
<td>4.863426e-19</td>
<td>3.770102e-16</td>
<td>1.504733e-11</td>
<td>7.523226e-09</td>
<td>1.627343e-10</td>
<td>1.057123e-13</td>
<td>1.000000</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2920</td>
<td>1.139901e-11</td>
<td>6.290391e-12</td>
<td>4.389559e-08</td>
<td>1.000000e+00</td>
<td>4.736745e-17</td>
<td>5.172185e-15</td>
<td>1.662083e-15</td>
<td>2.492923e-11</td>
<td>5.069354e-10</td>
<td>1.366577e-12</td>
<td>1.000000</td>
<td>3</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2847</td>
<td>2.374335e-11</td>
<td>5.410563e-10</td>
<td>1.000000e+00</td>
<td>6.474658e-10</td>
<td>3.318972e-12</td>
<td>1.285993e-12</td>
<td>1.194038e-08</td>
<td>1.259493e-15</td>
<td>1.686373e-10</td>
<td>9.267352e-15</td>
<td>1.000000</td>
<td>2</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4999</td>
<td>2.777072e-14</td>
<td>1.000000e+00</td>
<td>1.977435e-08</td>
<td>3.481474e-11</td>
<td>2.748897e-12</td>
<td>9.301366e-12</td>
<td>5.802548e-11</td>
<td>3.565957e-08</td>
<td>2.786610e-08</td>
<td>1.873916e-12</td>
<td>1.000000</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>5000 rows Ã— 13 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>y1 <span class="op">=</span> calib_prediction_results[min_std_indices_cal[<span class="dv">0</span>]]</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>y2 <span class="op">=</span> calib_prediction_results[min_std_indices_cal[<span class="dv">1</span>]]</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>y3 <span class="op">=</span> calib_prediction_results[min_std_indices_cal[<span class="dv">2</span>]]</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>y4 <span class="op">=</span> calib_prediction_results[<span class="dv">4500</span>]</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add bar plots to the subplots</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>bars1 <span class="op">=</span> axs[<span class="dv">0</span>, <span class="dv">0</span>].bar(x, y1, color<span class="op">=</span><span class="st">"#ff7f0e"</span>, width<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"True Label: </span><span class="sc">{</span>calib_target_results[min_std_indices_cal[<span class="dv">0</span>]]<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>bars2 <span class="op">=</span> axs[<span class="dv">0</span>, <span class="dv">1</span>].bar(x, y2, color<span class="op">=</span><span class="st">"#2ca02c"</span>, width<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"True Label: </span><span class="sc">{</span>calib_target_results[min_std_indices_cal[<span class="dv">1</span>]]<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>bars3 <span class="op">=</span> axs[<span class="dv">1</span>, <span class="dv">0</span>].bar(x, y3, color<span class="op">=</span><span class="st">"#1f77b4"</span>, width<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"True Label: </span><span class="sc">{</span>calib_target_results[min_std_indices_cal[<span class="dv">2</span>]]<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>bars4 <span class="op">=</span> axs[<span class="dv">1</span>, <span class="dv">1</span>].bar(x, y4, color<span class="op">=</span><span class="st">"#d62728"</span>, width<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"True Label: </span><span class="sc">{</span>calib_target_results[<span class="dv">4500</span>]<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">"bold"</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels and title to the figure</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Model's output on calibration dataset"</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axs.flat:</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    ax.grid(color<span class="op">=</span><span class="st">"gray"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Fine-tune the subplot layout</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>fig.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.03</span>, <span class="dv">1</span>, <span class="fl">0.95</span>])</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>bars1[calib_target_results[min_std_indices_cal[<span class="dv">0</span>]]].set_color(<span class="st">"#9467bd"</span>)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>bars2[calib_target_results[min_std_indices_cal[<span class="dv">1</span>]]].set_color(<span class="st">"#9467bd"</span>)</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>bars3[calib_target_results[min_std_indices_cal[<span class="dv">2</span>]]].set_color(<span class="st">"#9467bd"</span>)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>bars4[calib_target_results[<span class="dv">4500</span>]].set_color(<span class="st">"#9467bd"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-26-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>calib_true <span class="op">=</span> calib_prediction_results[</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    np.arange(calib_prediction_results.shape[<span class="dv">0</span>]), calib_target_results</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>From the above plot it is evident that most of the softmax outputs corresponding to the true label are either close to 1 or close to 0. Thus, once we find out the value corresponding to the threshold of the 0 peak in the plot. Any quantile value just above this will quickly go near the next peak as there is no distribution mass for the rest of the softmax outputs.</em></p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="54">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Quantile value that we use to predict the prediction set</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>qhat_intuit <span class="op">=</span> np.quantile(calib_true, <span class="fl">0.15</span>)  <span class="co">## taking 15% quantile</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>qhat_intuit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>0.17026243805885327</code></pre>
</div>
</div>
<p>_This leads to the fact that 85% of examples have their true class softmax score above <span class="math inline">\(\hat{q}_{intuit}\)</span>_</p>
<p><em>Sorting the test dataset according to std</em></p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>stds_test <span class="op">=</span> np.std(test_prediction_results, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>min_std_indices_test <span class="op">=</span> np.argsort(stds_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>test_df_std <span class="op">=</span> test_df.loc[min_std_indices_test]</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>test_df_std</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">Max</th>
<th data-quarto-table-cell-role="th">Max_idx</th>
<th data-quarto-table-cell-role="th">True_idx</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1646</td>
<td>9.070086e-06</td>
<td>7.102170e-02</td>
<td>1.074573e-01</td>
<td>2.019677e-01</td>
<td>2.011996e-01</td>
<td>1.028181e-03</td>
<td>1.132987e-03</td>
<td>1.039726e-01</td>
<td>1.606203e-01</td>
<td>1.515905e-01</td>
<td>0.201968</td>
<td>3</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1184</td>
<td>4.843292e-08</td>
<td>1.841913e-01</td>
<td>5.504493e-02</td>
<td>1.019774e-01</td>
<td>1.562013e-01</td>
<td>2.759257e-04</td>
<td>9.354739e-04</td>
<td>1.538243e-01</td>
<td>1.096576e-02</td>
<td>3.365835e-01</td>
<td>0.336583</td>
<td>9</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3654</td>
<td>4.213768e-04</td>
<td>7.209036e-02</td>
<td>1.887893e-02</td>
<td>1.189776e-02</td>
<td>3.334404e-01</td>
<td>2.851049e-03</td>
<td>1.309165e-01</td>
<td>8.140079e-04</td>
<td>2.165484e-01</td>
<td>2.121412e-01</td>
<td>0.333440</td>
<td>4</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3019</td>
<td>2.256842e-01</td>
<td>2.321515e-07</td>
<td>2.911193e-01</td>
<td>2.409384e-01</td>
<td>1.869016e-11</td>
<td>2.536230e-09</td>
<td>5.548395e-02</td>
<td>2.447040e-10</td>
<td>1.867739e-01</td>
<td>2.661302e-11</td>
<td>0.291119</td>
<td>2</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4896</td>
<td>1.610583e-01</td>
<td>4.679085e-05</td>
<td>8.821968e-04</td>
<td>1.386619e-01</td>
<td>1.308930e-03</td>
<td>8.392150e-05</td>
<td>3.836229e-02</td>
<td>5.723350e-02</td>
<td>2.713310e-01</td>
<td>3.310311e-01</td>
<td>0.331031</td>
<td>9</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3128</td>
<td>1.000000e+00</td>
<td>4.840718e-18</td>
<td>1.905646e-08</td>
<td>2.940498e-11</td>
<td>1.603996e-18</td>
<td>5.580763e-16</td>
<td>4.068423e-11</td>
<td>1.949603e-11</td>
<td>2.676126e-09</td>
<td>3.716259e-15</td>
<td>1.000000</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4507</td>
<td>1.798757e-18</td>
<td>1.045387e-13</td>
<td>5.538239e-17</td>
<td>2.234547e-16</td>
<td>7.610493e-18</td>
<td>6.503045e-19</td>
<td>4.574509e-24</td>
<td>1.000000e+00</td>
<td>1.466630e-14</td>
<td>1.054316e-12</td>
<td>1.000000</td>
<td>7</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3130</td>
<td>5.435448e-18</td>
<td>5.444775e-11</td>
<td>1.383103e-15</td>
<td>2.973889e-15</td>
<td>2.213195e-15</td>
<td>1.832753e-16</td>
<td>7.384352e-22</td>
<td>1.000000e+00</td>
<td>3.005146e-12</td>
<td>3.994342e-10</td>
<td>1.000000</td>
<td>7</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3142</td>
<td>1.000000e+00</td>
<td>2.979347e-17</td>
<td>1.458575e-08</td>
<td>1.863164e-11</td>
<td>1.070295e-18</td>
<td>1.046285e-15</td>
<td>7.635514e-11</td>
<td>2.087787e-12</td>
<td>5.457018e-09</td>
<td>3.388109e-15</td>
<td>1.000000</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3060</td>
<td>1.986817e-17</td>
<td>5.229983e-14</td>
<td>1.823637e-17</td>
<td>3.066719e-17</td>
<td>1.413327e-16</td>
<td>2.220211e-18</td>
<td>7.849721e-23</td>
<td>1.000000e+00</td>
<td>4.188006e-14</td>
<td>2.416875e-10</td>
<td>1.000000</td>
<td>7</td>
<td>7</td>
</tr>
</tbody>
</table>

<p>5000 rows Ã— 13 columns</p>
</div>
</div>
</div>
<div class="cell" data-scrolled="true" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Forming prediction sets</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>y1 <span class="op">=</span> test_prediction_results[min_std_indices_test[<span class="dv">1</span>]]</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>y2 <span class="op">=</span> test_prediction_results[min_std_indices_test[<span class="dv">2</span>]]</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>y3 <span class="op">=</span> test_prediction_results[min_std_indices_test[<span class="dv">3</span>]]</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>y4 <span class="op">=</span> test_prediction_results[<span class="dv">4500</span>]</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>test_array_indices <span class="op">=</span> [</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    min_std_indices_test[<span class="dv">1</span>],</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    min_std_indices_test[<span class="dv">2</span>],</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    min_std_indices_test[<span class="dv">3</span>],</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4500</span>,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="dv">10</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new figure with 3 subplots</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>))</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Add bar plots to the subplots</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>bars1 <span class="op">=</span> axs[<span class="dv">0</span>, <span class="dv">0</span>].bar(x, y1, color<span class="op">=</span><span class="st">"#ff7f0e"</span>, width<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"True Label: </span><span class="sc">{</span>test_target_results[test_array_indices[<span class="dv">0</span>]]<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>bars2 <span class="op">=</span> axs[<span class="dv">0</span>, <span class="dv">1</span>].bar(x, y2, color<span class="op">=</span><span class="st">"#2ca02c"</span>, width<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"True Label: </span><span class="sc">{</span>test_target_results[test_array_indices[<span class="dv">1</span>]]<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>bars3 <span class="op">=</span> axs[<span class="dv">1</span>, <span class="dv">0</span>].bar(x, y3, color<span class="op">=</span><span class="st">"#1f77b4"</span>, width<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"True Label: </span><span class="sc">{</span>test_target_results[test_array_indices[<span class="dv">2</span>]]<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>    fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>bars4 <span class="op">=</span> axs[<span class="dv">1</span>, <span class="dv">1</span>].bar(x, y4, color<span class="op">=</span><span class="st">"#d62728"</span>, width<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"True Label: </span><span class="sc">{</span>test_target_results[test_array_indices[<span class="dv">3</span>]]<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>    fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels and title to the figure</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Model's output on test dataset"</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axs.flat:</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>    ax.grid(color<span class="op">=</span><span class="st">"gray"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axs.flatten():</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>    ax.axhline(y<span class="op">=</span>qhat_intuit, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Fine-tune the subplot layout</span></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>fig.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.03</span>, <span class="dv">1</span>, <span class="fl">0.95</span>])</span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>bars1_idx <span class="op">=</span> y1 <span class="op">&gt;</span> qhat_intuit</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>bars2_idx <span class="op">=</span> y2 <span class="op">&gt;</span> qhat_intuit</span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>bars3_idx <span class="op">=</span> y3 <span class="op">&gt;</span> qhat_intuit</span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>bars4_idx <span class="op">=</span> y4 <span class="op">&gt;</span> qhat_intuit</span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bars1_idx[i]:</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a>        bars1[i].set_color(<span class="st">"#8c564b"</span>)</span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bars2_idx[i]:</span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>        bars2[i].set_color(<span class="st">"#8c564b"</span>)</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bars3_idx[i]:</span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>        bars3[i].set_color(<span class="st">"#8c564b"</span>)</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bars4_idx[i]:</span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>        bars4[i].set_color(<span class="st">"#8c564b"</span>)</span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a>bars1[test_target_results[test_array_indices[<span class="dv">0</span>]]].set_color(<span class="st">"#9467bd"</span>)</span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a>bars2[test_target_results[test_array_indices[<span class="dv">1</span>]]].set_color(<span class="st">"#9467bd"</span>)</span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a>bars3[test_target_results[test_array_indices[<span class="dv">2</span>]]].set_color(<span class="st">"#9467bd"</span>)</span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a>bars4[test_target_results[test_array_indices[<span class="dv">3</span>]]].set_color(<span class="st">"#9467bd"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-31-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>_All the bars above the <span class="math inline">\(\hat{q}_{intuit}\)</span> are the part of the prediction set for the corresponding test dataset_</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use numpy indexing to get the softmax scores for each image corresponding to their true labels</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>test_true <span class="op">=</span> test_prediction_results[</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    np.arange(test_prediction_results.shape[<span class="dv">0</span>]), test_target_results</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="implementing-conformal-prediction-using-the-general-method" class="level2">
<h2 class="anchored" data-anchor-id="implementing-conformal-prediction-using-the-general-method"><em>Implementing conformal prediction using the General Method</em></h2>
<p><em>1. Here the heuristic notion of uncertainity is softmax output</em></p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Problem setup</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">5000</span>  <span class="co"># number of calibration points</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.15</span>  <span class="co"># 1-alpha is the desired coverage</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>cal_scores <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> calib_true</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>2. Defining the score function as: <span class="math inline">\(S(x,y)\)</span> = <span class="math inline">\(1- softmax(x_i,y_i)\)</span></em></p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>q_level <span class="op">=</span> np.ceil((n <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> alpha)) <span class="op">/</span> n  <span class="co">## alpha = 0.1, n = 1000, q_level = 0.901</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>qhat <span class="op">=</span> np.quantile(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    cal_scores, q_level</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>)  <span class="co">## value for which 90% of the scores are less than it</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>qhat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>0.8337927011847496</code></pre>
</div>
</div>
<p><em>3. Calculating <span class="math inline">\(\hat{q}\)</span></em></p>
<p><em>4. Creating the prediction set</em></p>
<p>$ C(x) = {y:S(x,y) }$</p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, i <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    plt.imshow(test_images[test_array_indices[i]][<span class="dv">0</span>], cmap<span class="op">=</span><span class="st">"gray"</span>, interpolation<span class="op">=</span><span class="st">"none"</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    test_scores <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> test_prediction_results[test_array_indices[i]]</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    prediction_set <span class="op">=</span> test_scores <span class="op">&lt;</span> qhat</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> []</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, val <span class="kw">in</span> <span class="bu">enumerate</span>(prediction_set):</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> val:</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>            indices.append(index)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    true_label <span class="op">=</span> test_target_results[test_array_indices]</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"Set: </span><span class="sc">{</span>indices<span class="sc">}</span><span class="ss"> True:</span><span class="sc">{</span>true_label[i]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    plt.xticks([])</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    plt.yticks([])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-36-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="insights-and-summary" class="level2">
<h2 class="anchored" data-anchor-id="insights-and-summary"><em>Insights and Summary:</em></h2>
<ol type="1">
<li><p>Given an image <span class="math inline">\(x\)</span> and label <span class="math inline">\(j\)</span>. Softmax measures <span class="math inline">\(P(Y = j | X = x)\)</span>. However, we have no guarantee that the softmax outputs are any good; they maybe arbitrarily overfit or otherwise untrustworthy. Thus, we use the holdout set to adjust for their deficiencies.</p></li>
<li><p>In the above example the holdout set contained 5000 examples that the model never saw during training which gives us an honest appraisal of its performance.</p></li>
<li><p>Here, the conformal score was 1 - softmax output of the true class. Then we took $ = 1 - $ quantile of the scores.</p></li>
<li><p>Using Step 3 at the test time, we got the softmax outputs of a new image <span class="math inline">\(X_{test}\)</span> and collected all classes with outputs above $ 1 âˆ’ $ into a prediction set <span class="math inline">\(C(X_{test})\)</span></p></li>
</ol>
<section id="implementation-using-imagenet" class="level3">
<h3 class="anchored" data-anchor-id="implementation-using-imagenet"><em>Implementation using Imagenet</em></h3>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">"../data"</span>):</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    os.system(<span class="st">"gdown 1h7S6N_Rx7gdfO3ZunzErZy6H7620EbZK -O ../data.tar.gz"</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    os.system(<span class="st">"tar -xf ../data.tar.gz -C ../"</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    os.system(<span class="st">"rm ../data.tar.gz"</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">"../data/imagenet/human_readable_labels.json"</span>):</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>wget <span class="op">-</span>nv <span class="op">-</span>O ..<span class="op">/</span>data<span class="op">/</span>imagenet<span class="op">/</span>human_readable_labels.json <span class="op">-</span>L https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>anishathalye<span class="op">/</span>imagenet<span class="op">-</span>simple<span class="op">-</span>labels<span class="op">/</span>master<span class="op">/</span>imagenet<span class="op">-</span>simple<span class="op">-</span>labels.json</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> np.load(<span class="st">"../data/imagenet/imagenet-resnet152.npz"</span>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>example_paths <span class="op">=</span> os.listdir(<span class="st">"../data/imagenet/examples"</span>)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>smx <span class="op">=</span> data[<span class="st">"smx"</span>]</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> data[<span class="st">"labels"</span>].astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Problem setup</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">1000</span>  <span class="co"># number of calibration points</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.1</span>  <span class="co"># 1-alpha is the desired coverage</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> np.array([<span class="dv">1</span>] <span class="op">*</span> n <span class="op">+</span> [<span class="dv">0</span>] <span class="op">*</span> (smx.shape[<span class="dv">0</span>] <span class="op">-</span> n)) <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>np.random.shuffle(idx)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>cal_smx, val_smx <span class="op">=</span> smx[idx, :], smx[<span class="op">~</span>idx, :]</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>cal_labels, val_labels <span class="op">=</span> labels[idx], labels[<span class="op">~</span>idx]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>imagenet_calib_df <span class="op">=</span> pd.DataFrame(cal_smx)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>imagenet_calib_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">990</th>
<th data-quarto-table-cell-role="th">991</th>
<th data-quarto-table-cell-role="th">992</th>
<th data-quarto-table-cell-role="th">993</th>
<th data-quarto-table-cell-role="th">994</th>
<th data-quarto-table-cell-role="th">995</th>
<th data-quarto-table-cell-role="th">996</th>
<th data-quarto-table-cell-role="th">997</th>
<th data-quarto-table-cell-role="th">998</th>
<th data-quarto-table-cell-role="th">999</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>9.646587e-01</td>
<td>1.350361e-05</td>
<td>2.151330e-07</td>
<td>1.699551e-06</td>
<td>2.384544e-06</td>
<td>1.646308e-06</td>
<td>1.394906e-07</td>
<td>2.117511e-08</td>
<td>3.057390e-09</td>
<td>4.086660e-10</td>
<td>...</td>
<td>5.279725e-09</td>
<td>9.462966e-08</td>
<td>1.185813e-08</td>
<td>5.307772e-10</td>
<td>2.161666e-07</td>
<td>1.007043e-08</td>
<td>9.514928e-08</td>
<td>8.144019e-07</td>
<td>1.339111e-07</td>
<td>6.878381e-09</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>9.992527e-01</td>
<td>1.005275e-06</td>
<td>5.030975e-08</td>
<td>2.312540e-08</td>
<td>6.919812e-07</td>
<td>5.068674e-08</td>
<td>5.945228e-08</td>
<td>2.580266e-09</td>
<td>1.059923e-09</td>
<td>5.929557e-11</td>
<td>...</td>
<td>3.178681e-10</td>
<td>3.120479e-09</td>
<td>2.160190e-09</td>
<td>6.229624e-10</td>
<td>3.004631e-08</td>
<td>2.982520e-10</td>
<td>3.827619e-08</td>
<td>2.310420e-07</td>
<td>9.114003e-08</td>
<td>6.513726e-10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>9.998410e-01</td>
<td>2.081634e-08</td>
<td>2.163244e-09</td>
<td>1.033369e-08</td>
<td>9.947884e-09</td>
<td>4.689700e-09</td>
<td>4.500399e-09</td>
<td>4.603104e-11</td>
<td>2.665861e-11</td>
<td>4.032333e-12</td>
<td>...</td>
<td>1.170430e-10</td>
<td>1.740400e-10</td>
<td>1.001514e-10</td>
<td>2.484425e-11</td>
<td>6.860166e-10</td>
<td>5.098253e-11</td>
<td>9.393597e-10</td>
<td>3.404014e-08</td>
<td>1.460277e-09</td>
<td>8.657306e-13</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>9.996231e-01</td>
<td>6.980400e-06</td>
<td>7.547856e-08</td>
<td>1.445374e-07</td>
<td>5.570853e-07</td>
<td>1.413495e-06</td>
<td>1.172659e-07</td>
<td>4.219434e-09</td>
<td>9.644072e-10</td>
<td>4.150972e-11</td>
<td>...</td>
<td>1.467458e-09</td>
<td>1.727905e-08</td>
<td>4.188708e-08</td>
<td>8.764998e-10</td>
<td>3.017675e-08</td>
<td>1.152834e-09</td>
<td>2.212167e-08</td>
<td>5.312061e-07</td>
<td>7.742039e-09</td>
<td>6.035842e-10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3.740840e-07</td>
<td>9.997242e-01</td>
<td>6.791072e-10</td>
<td>4.707819e-09</td>
<td>3.942747e-09</td>
<td>3.235905e-07</td>
<td>1.922253e-08</td>
<td>7.563041e-09</td>
<td>4.848560e-09</td>
<td>1.836324e-11</td>
<td>...</td>
<td>1.428742e-09</td>
<td>2.168828e-09</td>
<td>7.591582e-10</td>
<td>7.432400e-11</td>
<td>8.145293e-10</td>
<td>6.436701e-10</td>
<td>6.601004e-10</td>
<td>2.608228e-10</td>
<td>1.372821e-09</td>
<td>1.686885e-07</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">995</td>
<td>1.338609e-13</td>
<td>2.481204e-13</td>
<td>2.981873e-12</td>
<td>2.992094e-12</td>
<td>8.025680e-13</td>
<td>1.196738e-12</td>
<td>1.058158e-12</td>
<td>1.031028e-14</td>
<td>8.366420e-14</td>
<td>1.834110e-16</td>
<td>...</td>
<td>2.835526e-10</td>
<td>1.185883e-09</td>
<td>5.707088e-11</td>
<td>1.053065e-10</td>
<td>6.115803e-09</td>
<td>1.000000e+00</td>
<td>6.104551e-11</td>
<td>3.662891e-10</td>
<td>2.519912e-13</td>
<td>1.617798e-11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">996</td>
<td>1.461727e-05</td>
<td>2.962031e-05</td>
<td>2.201413e-07</td>
<td>3.813796e-08</td>
<td>1.196295e-07</td>
<td>3.246882e-07</td>
<td>2.723306e-06</td>
<td>2.824044e-06</td>
<td>9.639041e-06</td>
<td>2.289236e-05</td>
<td>...</td>
<td>2.566843e-02</td>
<td>1.156482e-01</td>
<td>1.163806e-03</td>
<td>6.741311e-03</td>
<td>1.174134e-03</td>
<td>1.015575e-03</td>
<td>4.271199e-01</td>
<td>3.027194e-01</td>
<td>3.415058e-04</td>
<td>8.422194e-07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">997</td>
<td>3.484188e-06</td>
<td>1.047919e-07</td>
<td>7.475886e-08</td>
<td>3.465406e-07</td>
<td>1.347377e-06</td>
<td>4.767327e-06</td>
<td>4.182576e-08</td>
<td>4.709841e-08</td>
<td>1.508235e-08</td>
<td>1.065061e-08</td>
<td>...</td>
<td>2.632773e-06</td>
<td>2.174731e-05</td>
<td>3.774206e-04</td>
<td>1.449335e-04</td>
<td>8.616778e-01</td>
<td>8.140442e-05</td>
<td>1.180090e-04</td>
<td>1.335993e-01</td>
<td>7.427732e-06</td>
<td>3.561391e-08</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">998</td>
<td>7.082336e-04</td>
<td>2.196637e-05</td>
<td>1.516250e-05</td>
<td>7.714512e-04</td>
<td>1.190577e-01</td>
<td>5.289520e-02</td>
<td>3.330159e-04</td>
<td>1.690781e-07</td>
<td>1.402206e-06</td>
<td>4.881958e-08</td>
<td>...</td>
<td>1.218608e-05</td>
<td>2.880947e-03</td>
<td>5.116140e-04</td>
<td>1.090989e-01</td>
<td>8.638866e-03</td>
<td>3.532250e-02</td>
<td>1.301925e-02</td>
<td>5.380661e-01</td>
<td>1.777594e-05</td>
<td>4.036425e-07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">999</td>
<td>4.129702e-14</td>
<td>2.889617e-12</td>
<td>2.798768e-13</td>
<td>4.931771e-13</td>
<td>2.598153e-12</td>
<td>9.916586e-14</td>
<td>3.006582e-13</td>
<td>8.608723e-12</td>
<td>2.060572e-12</td>
<td>5.938183e-13</td>
<td>...</td>
<td>1.010096e-11</td>
<td>1.221625e-11</td>
<td>2.120370e-11</td>
<td>2.549839e-13</td>
<td>5.645862e-10</td>
<td>5.007978e-11</td>
<td>3.019627e-10</td>
<td>1.544346e-11</td>
<td>1.280130e-11</td>
<td>9.915479e-01</td>
</tr>
</tbody>
</table>

<p>1000 rows Ã— 1000 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="adaptive-prediction-sets" class="level2">
<h2 class="anchored" data-anchor-id="adaptive-prediction-sets"><em>Adaptive Prediction Sets</em></h2>
<p>In comparison to the earlier method:</p>
<ol type="1">
<li>This method will have a larger predictive set size.</li>
<li>Much more adaptive (<span class="math inline">\(i.e.\)</span> Larger set size for hard examples and small set size for easy examples).</li>
<li>The earlier method used the softmax value corresponding to only the true class of the output.</li>
</ol>
<section id="implementation" class="level3">
<h3 class="anchored" data-anchor-id="implementation"><em>Implementation</em></h3>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">"../data"</span>):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    os.system(<span class="st">"gdown 1h7S6N_Rx7gdfO3ZunzErZy6H7620EbZK -O ../data.tar.gz"</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    os.system(<span class="st">"tar -xf ../data.tar.gz -C ../"</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    os.system(<span class="st">"rm ../data.tar.gz"</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">"../data/imagenet/human_readable_labels.json"</span>):</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>wget <span class="op">-</span>nv <span class="op">-</span>O ..<span class="op">/</span>data<span class="op">/</span>imagenet<span class="op">/</span>human_readable_labels.json <span class="op">-</span>L https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>anishathalye<span class="op">/</span>imagenet<span class="op">-</span>simple<span class="op">-</span>labels<span class="op">/</span>master<span class="op">/</span>imagenet<span class="op">-</span>simple<span class="op">-</span>labels.json</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> np.load(<span class="st">"../data/imagenet/imagenet-resnet152.npz"</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>example_paths <span class="op">=</span> os.listdir(<span class="st">"../data/imagenet/examples"</span>)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>smx <span class="op">=</span> data[<span class="st">"smx"</span>]</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> data[<span class="st">"labels"</span>].astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Problem setup</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">1000</span>  <span class="co"># number of calibration points</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.1</span>  <span class="co"># 1-alpha is the desired coverage</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> np.array([<span class="dv">1</span>] <span class="op">*</span> n <span class="op">+</span> [<span class="dv">0</span>] <span class="op">*</span> (smx.shape[<span class="dv">0</span>] <span class="op">-</span> n)) <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>np.random.shuffle(idx)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>cal_smx, val_smx <span class="op">=</span> smx[idx, :], smx[<span class="op">~</span>idx, :]</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>cal_labels, val_labels <span class="op">=</span> labels[idx], labels[<span class="op">~</span>idx]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="45">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>cal_pi <span class="op">=</span> cal_smx.argsort(<span class="dv">1</span>)[</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    :, ::<span class="op">-</span><span class="dv">1</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>]  <span class="co">## sorting the cal_smx in descending order and storing the indices in cal_pi</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>cal_srt <span class="op">=</span> np.take_along_axis(cal_smx, cal_pi, axis<span class="op">=</span><span class="dv">1</span>).cumsum(</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>)  <span class="co">##  take the elements of 'cal_smx' corresponding to the indices in 'cal_pi' and take the cumulative sum along each row</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>cal_scores <span class="op">=</span> np.take_along_axis(cal_srt, cal_pi.argsort(axis<span class="op">=</span><span class="dv">1</span>), axis<span class="op">=</span><span class="dv">1</span>)[</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">range</span>(n), cal_labels</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>]  <span class="co">##  take the elements of 'cal_srt' corresponding to the indices of the sorted 'cal_pi' and select the score corresponding to the 'cal_labels'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="46">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>example <span class="op">=</span> np.array(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">6</span>],</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">3</span>],</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">9</span>, <span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">7</span>],</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">7</span>, <span class="dv">8</span>],</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">6</span>],</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>example_labels <span class="op">=</span> np.array([<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">2</span>])</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>example_pi <span class="op">=</span> example.argsort(<span class="dv">1</span>)[:, ::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(example_pi)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>example_srt <span class="op">=</span> np.take_along_axis(example, example_pi, axis<span class="op">=</span><span class="dv">1</span>).cumsum(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(example_srt)</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>example_scores <span class="op">=</span> np.take_along_axis(example_srt, example_pi.argsort(axis<span class="op">=</span><span class="dv">1</span>), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(example_scores)</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>example_scores[<span class="bu">range</span>(<span class="dv">5</span>), example_labels]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[4 1 0 2 3]
 [3 2 0 1 4]
 [0 4 1 2 3]
 [4 3 0 1 2]
 [4 1 2 3 0]]
[[ 6 10 13 15 16]
 [ 7 13 18 22 25]
 [ 9 16 21 25 28]
 [ 8 15 20 24 27]
 [ 6  9 11 12 12]]
[[13 10 15 16  6]
 [18 22 13  7 25]
 [ 9 21 25 28 16]
 [20 24 27 15  8]
 [12  9 11 12  6]]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>array([15,  7, 21,  8, 11])</code></pre>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="47">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># example = np.array([[3,4,2,1,6],[5,4,6,7,3],[9,5,4,3,7],[5,4,3,7,8],[0,3,2,1,6]])</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># example_pi = example.sort()</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># print(example_pi)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>1. The softmax output corresponding to an image is sorted in decreasing order. Then we consider the <span class="math inline">\(E_i\)</span> as the total mass of the softmax function for a particular label until we reach the true label.</em></p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the score quantile</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>qhat <span class="op">=</span> np.quantile(cal_scores, np.ceil((n <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> alpha)) <span class="op">/</span> n)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>qhat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>0.9998794758319854</code></pre>
</div>
</div>
<p><em>2. Calculating the quantile value <span class="math inline">\(\hat{q}\)</span></em></p>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="49">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy (output=list of length n, each element is tensor of classes)</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>val_pi <span class="op">=</span> val_smx.argsort(<span class="dv">1</span>)[:, ::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>val_srt <span class="op">=</span> np.take_along_axis(val_smx, val_pi, axis<span class="op">=</span><span class="dv">1</span>).cumsum(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>prediction_sets <span class="op">=</span> np.take_along_axis(val_srt <span class="op">&lt;=</span> qhat, val_pi.argsort(axis<span class="op">=</span><span class="dv">1</span>), axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="50">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>eg <span class="op">=</span> np.array([<span class="dv">7</span>, <span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">7</span>])</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>eg_pi <span class="op">=</span> eg.argsort()[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>eg_srt <span class="op">=</span> np.take_along_axis(eg, eg_pi, axis<span class="op">=</span><span class="dv">0</span>).cumsum()</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>p_set <span class="op">=</span> np.take_along_axis(eg_srt <span class="op">&lt;=</span> <span class="fl">0.8</span>, eg_pi.argsort(), axis<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> smx[<span class="dv">1</span>][<span class="dv">0</span>:<span class="dv">10</span>]</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>img_pi <span class="op">=</span> img.argsort()[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>img_srt <span class="op">=</span> np.take_along_axis(img, img_pi, axis<span class="op">=</span><span class="dv">0</span>).cumsum()</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>prediction_set <span class="op">=</span> np.take_along_axis(img_srt <span class="op">&lt;=</span> qhat, img_pi.argsort(), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(img_pi, img, img_srt, prediction_set)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0 1 4 3 5 2 6 7 8 9] [9.64658678e-01 1.35036071e-05 2.15132957e-07 1.69955081e-06
 2.38454436e-06 1.64630808e-06 1.39490609e-07 2.11751061e-08
 3.05739034e-09 4.08666018e-10] [0.96465868 0.96467218 0.96467457 0.96467627 0.96467791 0.96467813
 0.96467827 0.96467829 0.96467829 0.96467829] [ True  True  True  True  True  True  True  True  True  True]</code></pre>
</div>
</div>
<div class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;subslide&quot;}" data-execution_count="52">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"../data/imagenet/human_readable_labels.json"</span>) <span class="im">as</span> f:</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    label_strings <span class="op">=</span> np.array(json.load(f))</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>example_paths <span class="op">=</span> os.listdir(<span class="st">"../data/imagenet/examples"</span>)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    rand_path <span class="op">=</span> np.random.choice(example_paths)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> imread(<span class="st">"../data/imagenet/examples/"</span> <span class="op">+</span> rand_path)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    img_index <span class="op">=</span> <span class="bu">int</span>(rand_path.split(<span class="st">"."</span>)[<span class="dv">0</span>])</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    img_pi <span class="op">=</span> smx[img_index].argsort()[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    img_srt <span class="op">=</span> np.take_along_axis(smx[img_index], img_pi, axis<span class="op">=</span><span class="dv">0</span>).cumsum()</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    prediction_set <span class="op">=</span> np.take_along_axis(img_srt <span class="op">&lt;=</span> qhat, img_pi.argsort(), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    plt.figure()</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    plt.imshow(img)</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">"off"</span>)</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"The prediction set is: </span><span class="sc">{</span><span class="bu">list</span>(label_strings[prediction_set])<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-51-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>The prediction set is: ['prairie grouse', 'partridge', 'Afghan Hound', 'Otterhound', 'Bedlington Terrier', 'Kerry Blue Terrier', 'Giant Schnauzer', 'Flat-Coated Retriever', 'Curly-coated Retriever', 'Chesapeake Bay Retriever', 'German Shorthaired Pointer', 'Vizsla', 'Irish Setter', 'Gordon Setter', 'Brittany', 'Clumber Spaniel', 'English Springer Spaniel', 'Welsh Springer Spaniel', 'Cocker Spaniels', 'Sussex Spaniel', 'Irish Water Spaniel', 'Australian Kelpie', 'Komondor', 'Newfoundland', 'Toy Poodle', 'Miniature Poodle', 'Standard Poodle', 'hyena', 'leopard', 'cheetah', 'brown bear', 'American black bear', 'mongoose', 'wild boar', 'bison', 'ram', 'llama', 'weasel', 'mink', 'guenon', 'baboon', 'honeycomb', 'jeep', 'wig', 'acorn', 'gyromitra']
The prediction set is: ['Otterhound', 'Border Terrier', 'Norfolk Terrier', 'Norwich Terrier', 'Yorkshire Terrier', 'Wire Fox Terrier', 'Lakeland Terrier', 'Airedale Terrier', 'Cairn Terrier', 'Australian Terrier', 'Dandie Dinmont Terrier', 'Miniature Schnauzer', 'Standard Schnauzer', 'Scottish Terrier', 'Australian Silky Terrier', 'German Shepherd Dog']
The prediction set is: ['goldfish', 'tiger shark', 'cock', 'house finch', 'agama', 'triceratops', 'ring-necked snake', 'sea snake', 'southern black widow', 'centipede', 'black grouse', 'prairie grouse', 'grey parrot', 'macaw', 'lorikeet', 'hornbill', 'hummingbird', 'toucan', 'flatworm', 'nematode', 'sea slug', 'fiddler crab', 'American lobster', 'spiny lobster', 'crayfish', 'hermit crab', 'isopod', 'crane (bird)', 'oystercatcher', 'Bloodhound', 'Miniature Schnauzer', 'Giant Schnauzer', 'Standard Schnauzer', 'Labrador Retriever', 'English Setter', 'Gordon Setter', 'Brittany', 'Cocker Spaniels', 'Sussex Spaniel', 'Rottweiler', 'Greater Swiss Mountain Dog', 'Dalmatian', 'cougar', 'tiger', 'polar bear', 'mongoose', 'ladybug', 'stick insect', 'cockroach', 'leafhopper', 'damselfly', 'red admiral', 'gossamer-winged butterfly', 'sea cucumber', 'hamster', 'beaver', 'guinea pig', 'pig', 'weasel', 'mink', 'European polecat', 'black-footed ferret', 'skunk', 'badger', 'macaque', 'marmoset', 'red panda', 'eel', 'coho salmon', 'rock beauty', 'clownfish', 'sturgeon', 'garfish', 'lionfish', 'aircraft carrier', 'airliner', 'airship', 'ambulance', 'amphibious vehicle', 'analog clock', 'apiary', 'waste container', 'assault rifle', 'backpack', 'balance beam', 'balloon', 'Band-Aid', 'baluster', 'barber chair', 'barbershop', 'barometer', 'barrel', 'wheelbarrow', 'baseball', 'swimming cap', 'bathtub', 'station wagon', 'lighthouse', 'beaker', 'beer bottle', 'binoculars', 'birdhouse', 'boathouse', 'bolo tie', 'bottle cap', 'breakwater', 'broom', 'buckle', 'bulletproof vest', 'high-speed train', 'taxicab', 'cannon', 'canoe', 'can opener', 'car mirror', 'carousel', 'tool kit', 'car wheel', 'automated teller machine', 'cassette', 'cassette player', 'catamaran', 'CD player', 'mobile phone', 'chain', 'chain-link fence', 'chainsaw', 'movie theater', 'coffeemaker', 'computer keyboard', 'container ship', 'convertible', 'cowboy hat', 'crane (machine)', 'crash helmet', 'crate', 'crutch', 'dam', 'desk', 'desktop computer', 'rotary dial telephone', 'digital clock', 'digital watch', 'dishwasher', 'disc brake', 'dock', 'dog sled', 'drilling rig', 'dumbbell', 'Dutch oven', 'electric fan', 'electric locomotive', 'envelope', 'feather boa', 'fireboat', 'fire engine', 'football helmet', 'forklift', 'freight car', 'frying pan', 'garbage truck', 'gas mask', 'gas pump', 'go-kart', 'golf ball', 'golf cart', 'grille', 'grocery store', 'guillotine', 'barrette', 'half-track', 'hammer', 'hand-held computer', 'hard disk drive', 'harvester', 'hatchet', 'holster', 'honeycomb', 'hook', 'horizontal bar', 'horse-drawn vehicle', "jack-o'-lantern", 'jeep', 'jigsaw puzzle', 'pulled rickshaw', 'joystick', 'knot', 'lab coat', 'ladle', 'laptop computer', 'lawn mower', 'lifeboat', 'lighter', 'limousine', 'ocean liner', 'speaker', 'sawmill', 'magnetic compass', 'mailbox', 'manhole cover', 'match', 'maze', 'medicine chest', 'microwave oven', 'military uniform', 'milk can', 'minibus', 'minivan', 'missile', 'mobile home', 'Model T', 'modem', 'monitor', 'moped', 'mortar', 'scooter', 'mountain bike', 'tent', 'computer mouse', 'mousetrap', 'moving van', 'neck brace', 'odometer', 'oil filter', 'oscilloscope', 'bullock cart', 'oxygen mask', 'packet', 'paddle wheel', 'padlock', 'paintbrush', 'parachute', 'parking meter', 'passenger car', 'payphone', 'pencil case', 'pencil sharpener', 'Petri dish', 'photocopier', 'picket fence', 'pickup truck', 'pier', 'pill bottle', 'ping-pong ball', 'hand plane', 'plow', 'plunger', 'Polaroid camera', 'pole', 'police van', 'soda bottle', 'power drill', 'printer', 'projectile', 'projector', 'hockey puck', 'punching bag', 'race car', 'radiator', 'radio', 'radio telescope', 'rain barrel', 'recreational vehicle', 'reflex camera', 'refrigerator', 'remote control', 'restaurant', 'revolver', 'rifle', 'rotisserie', 'eraser', 'ruler', 'running shoe', 'safe', 'sandal', 'weighing scale', 'school bus', 'scoreboard', 'CRT screen', 'screw', 'screwdriver', 'seat belt', 'sewing machine', 'shopping cart', 'shovel', 'ski', 'sleeping bag', 'slide rule', 'sliding door', 'slot machine', 'snorkel', 'snowmobile', 'snowplow', 'solar thermal collector', 'space bar', 'space heater', 'space shuttle', 'motorboat', 'sports car', 'spotlight', 'steam locomotive', 'through arch bridge', 'stopwatch', 'stove', 'strainer', 'tram', 'stretcher', 'suspension bridge', 'mop', 'swing', 'switch', 'syringe', 'tank', 'tape player', 'television', 'threshing machine', 'tile roof', 'toaster', 'toilet seat', 'torch', 'totem pole', 'tow truck', 'toy store', 'tractor', 'semi-trailer truck', 'tray', 'trimaran', 'trolleybus', 'tub', 'turnstile', 'typewriter keyboard', 'viaduct', 'wall clock', 'military aircraft', 'sink', 'washing machine', 'water bottle', 'water tower', 'whistle', 'wing', 'shipwreck', 'yurt', 'website', 'traffic sign', 'traffic light', 'dust jacket', 'ice pop', 'hot dog', 'spaghetti squash', 'acorn squash', 'butternut squash', 'cucumber', 'hay', 'meatloaf', 'burrito', 'alp', 'bubble', 'cliff', 'coral reef', 'volcano', 'baseball player', 'scuba diver', 'rapeseed', 'corn', 'coral fungus', 'agaric', 'stinkhorn mushroom', 'ear']
The prediction set is: ['alligator lizard', 'trilobite', 'scorpion', 'tick', 'centipede', 'conch', 'snail', 'chiton', 'crayfish', 'hermit crab', 'isopod', 'ground beetle', 'weevil', 'cockroach', 'cicada', 'sea cucumber', 'armadillo', 'corn']
The prediction set is: ['tench', 'great white shark', 'tiger shark', 'hammerhead shark', 'electric ray', 'stingray', 'cock', 'hen', 'house finch', 'junco', 'indigo bunting', 'vulture', 'spotted salamander', 'loggerhead sea turtle', 'leatherback sea turtle', 'green iguana', 'desert grassland whiptail lizard', 'frilled-necked lizard', 'Gila monster', 'European green lizard', 'triceratops', 'eastern hog-nosed snake', 'kingsnake', 'vine snake', 'night snake', 'boa constrictor', 'harvestman', 'scorpion', 'yellow garden spider', 'barn spider', 'European garden spider', 'southern black widow', 'tarantula', 'tick', 'centipede', 'black grouse', 'ruffed grouse', 'prairie grouse', 'partridge', 'grey parrot', 'macaw', 'sulphur-crested cockatoo', 'coucal', 'hornbill', 'toucan', 'tusker', 'echidna', 'wombat', 'jellyfish', 'sea anemone', 'flatworm', 'conch', 'slug', 'chambered nautilus', 'Dungeness crab', 'rock crab', 'red king crab', 'American lobster', 'spiny lobster', 'crayfish', 'hermit crab', 'isopod', 'American coot', 'dunlin', 'king penguin', 'albatross', 'grey whale', 'killer whale', 'dugong', 'sea lion', 'Chihuahua', 'Japanese Chin', 'Maltese', 'Pekingese', 'Shih Tzu', 'King Charles Spaniel', 'toy terrier', 'Rhodesian Ridgeback', 'Afghan Hound', 'Basset Hound', 'Beagle', 'Bloodhound', 'Bluetick Coonhound', 'Black and Tan Coonhound', 'Treeing Walker Coonhound', 'English foxhound', 'Redbone Coonhound', 'borzoi', 'Italian Greyhound', 'Weimaraner', 'Staffordshire Bull Terrier', 'American Staffordshire Terrier', 'Bedlington Terrier', 'Kerry Blue Terrier', 'Irish Terrier', 'Norfolk Terrier', 'Norwich Terrier', 'Yorkshire Terrier', 'Lakeland Terrier', 'Sealyham Terrier', 'Cairn Terrier', 'Australian Terrier', 'Dandie Dinmont Terrier', 'Boston Terrier', 'Miniature Schnauzer', 'Giant Schnauzer', 'Scottish Terrier', 'Tibetan Terrier', 'Australian Silky Terrier', 'Soft-coated Wheaten Terrier', 'West Highland White Terrier', 'Lhasa Apso', 'Flat-Coated Retriever', 'Curly-coated Retriever', 'Golden Retriever', 'Labrador Retriever', 'Chesapeake Bay Retriever', 'German Shorthaired Pointer', 'Vizsla', 'Gordon Setter', 'Brittany', 'Clumber Spaniel', 'English Springer Spaniel', 'Cocker Spaniels', 'Sussex Spaniel', 'Irish Water Spaniel', 'Kuvasz', 'Schipperke', 'Groenendael', 'Briard', 'Australian Kelpie', 'Komondor', 'Old English Sheepdog', 'Bouvier des Flandres', 'Rottweiler', 'German Shepherd Dog', 'Dobermann', 'Miniature Pinscher', 'Greater Swiss Mountain Dog', 'Bernese Mountain Dog', 'Appenzeller Sennenhund', 'Entlebucher Sennenhund', 'Boxer', 'Bullmastiff', 'Tibetan Mastiff', 'French Bulldog', 'Great Dane', 'husky', 'Alaskan Malamute', 'Siberian Husky', 'Dalmatian', 'Affenpinscher', 'Basenji', 'pug', 'Leonberger', 'Newfoundland', 'Pyrenean Mountain Dog', 'Samoyed', 'Pomeranian', 'Chow Chow', 'Griffon Bruxellois', 'Pembroke Welsh Corgi', 'Toy Poodle', 'Miniature Poodle', 'Standard Poodle', 'Mexican hairless dog', 'Alaskan tundra wolf', 'tabby cat', 'tiger cat', 'Persian cat', 'Siamese cat', 'Egyptian Mau', 'leopard', 'American black bear', 'ground beetle', 'rhinoceros beetle', 'grasshopper', 'cricket', 'stick insect', 'cockroach', 'mantis', 'ringlet', 'monarch butterfly', 'starfish', 'sea urchin', 'cottontail rabbit', 'Angora rabbit', 'hamster', 'porcupine', 'beaver', 'common sorrel', 'zebra', 'hippopotamus', 'ox', 'water buffalo', 'weasel', 'mink', 'European polecat', 'black-footed ferret', 'armadillo', 'gibbon', 'Asian elephant', 'African bush elephant', 'snoek', 'eel', 'coho salmon', 'rock beauty', 'sturgeon', 'garfish', 'lionfish', 'abacus', 'abaya', 'academic gown', 'accordion', 'acoustic guitar', 'aircraft carrier', 'airship', 'altar', 'ambulance', 'analog clock', 'apron', 'waste container', 'assault rifle', 'backpack', 'bakery', 'balloon', 'Band-Aid', 'banjo', 'baluster', 'barbell', 'barber chair', 'barbershop', 'barometer', 'barrel', 'baseball', 'basketball', 'bassinet', 'bassoon', 'swimming cap', 'bath towel', 'bathtub', 'station wagon', 'lighthouse', 'beaker', 'military cap', 'beer bottle', 'beer glass', 'bell-cot', 'bib', 'tandem bicycle', 'bikini', 'ring binder', 'binoculars', 'bobsleigh', 'bolo tie', 'poke bonnet', 'bookcase', 'bookstore', 'bow', 'bow tie', 'brass', 'bra', 'breastplate', 'broom', 'bucket', 'buckle', 'bulletproof vest', 'high-speed train', 'butcher shop', 'taxicab', 'cauldron', 'candle', 'cannon', 'can opener', 'cardigan', 'car mirror', 'carousel', 'tool kit', 'carton', 'car wheel', 'automated teller machine', 'cassette', 'cassette player', 'CD player', 'cello', 'mobile phone', 'chain', 'chain mail', 'chainsaw', 'chest', 'chiffonier', 'chime', 'china cabinet', 'Christmas stocking', 'church', 'movie theater', 'cleaver', 'cliff dwelling', 'cloak', 'clogs', 'cocktail shaker', 'coffee mug', 'coffeemaker', 'coil', 'combination lock', 'computer keyboard', 'confectionery store', 'convertible', 'corkscrew', 'cornet', 'cowboy boot', 'cowboy hat', 'cradle', 'crane (machine)', 'crash helmet', 'crate', 'infant bed', 'Crock Pot', 'croquet ball', 'crutch', 'cuirass', 'dam', 'desk', 'desktop computer', 'rotary dial telephone', 'diaper', 'digital clock', 'digital watch', 'dining table', 'dishcloth', 'dishwasher', 'disc brake', 'dock', 'dome', 'doormat', 'drilling rig', 'drum', 'drumstick', 'dumbbell', 'Dutch oven', 'electric fan', 'electric guitar', 'envelope', 'espresso machine', 'face powder', 'feather boa', 'filing cabinet', 'fireboat', 'fire screen sheet', 'flagpole', 'flute', 'folding chair', 'football helmet', 'forklift', 'fountain', 'fountain pen', 'four-poster bed', 'freight car', 'French horn', 'frying pan', 'fur coat', 'gas mask', 'gas pump', 'goblet', 'golf ball', 'golf cart', 'gondola', 'gong', 'gown', 'grand piano', 'grille', 'grocery store', 'guillotine', 'barrette', 'hair spray', 'hammer', 'hamper', 'hair dryer', 'hand-held computer', 'handkerchief', 'harmonica', 'harp', 'hatchet', 'holster', 'home theater', 'hook', 'hoop skirt', 'horizontal bar', 'hourglass', 'iPod', 'clothes iron', "jack-o'-lantern", 'jeans', 'T-shirt', 'pulled rickshaw', 'joystick', 'kimono', 'knee pad', 'knot', 'lab coat', 'ladle', 'lampshade', 'laptop computer', 'lens cap', 'library', 'limousine', 'ocean liner', 'lipstick', 'slip-on shoe', 'lotion', 'speaker', 'sawmill', 'magnetic compass', 'mail bag', 'mailbox', 'tights', 'tank suit', 'manhole cover', 'maraca', 'marimba', 'mask', 'match', 'maypole', 'maze', 'medicine chest', 'megalith', 'microphone', 'microwave oven', 'military uniform', 'milk can', 'minibus', 'miniskirt', 'minivan', 'missile', 'mitten', 'mobile home', 'Model T', 'modem', 'monastery', 'monitor', 'square academic cap', 'mosque', 'mosquito net', 'scooter', 'mountain bike', 'tent', 'mousetrap', 'moving van', 'muzzle', 'nail', 'neck brace', 'necklace', 'nipple', 'notebook computer', 'obelisk', 'oboe', 'ocarina', 'oil filter', 'organ', 'oscilloscope', 'overskirt', 'oxygen mask', 'packet', 'paddle', 'padlock', 'paintbrush', 'pajamas', 'palace', 'pan flute', 'paper towel', 'parachute', 'parallel bars', 'park bench', 'passenger car', 'patio', 'payphone', 'pedestal', 'pencil case', 'pencil sharpener', 'perfume', 'Petri dish', 'photocopier', 'plectrum', 'Pickelhaube', 'picket fence', 'pier', 'piggy bank', 'pill bottle', 'pillow', 'ping-pong ball', 'pirate ship', 'pitcher', 'planetarium', 'plastic bag', 'plate rack', 'plunger', 'Polaroid camera', 'pole', 'poncho', 'billiard table', 'soda bottle', 'pot', "potter's wheel", 'power drill', 'prayer rug', 'printer', 'prison', 'projectile', 'projector', 'punching bag', 'purse', 'quill', 'quilt', 'race car', 'racket', 'radiator', 'radio', 'radio telescope', 'rain barrel', 'recreational vehicle', 'reel', 'reflex camera', 'refrigerator', 'remote control', 'restaurant', 'revolver', 'rifle', 'rocking chair', 'rotisserie', 'rugby ball', 'ruler', 'running shoe', 'safe', 'safety pin', 'salt shaker', 'sandal', 'sarong', 'saxophone', 'scabbard', 'weighing scale', 'school bus', 'schooner', 'CRT screen', 'screw', 'screwdriver', 'seat belt', 'sewing machine', 'shield', 'shoe store', 'shoji', 'shopping basket', 'shopping cart', 'shovel', 'shower cap', 'shower curtain', 'ski mask', 'sleeping bag', 'sliding door', 'slot machine', 'snorkel', 'soap dispenser', 'soccer ball', 'sock', 'solar thermal collector', 'sombrero', 'space bar', 'space heater', 'space shuttle', 'spatula', 'spider web', 'spindle', 'sports car', 'spotlight', 'stage', 'through arch bridge', 'steel drum', 'stethoscope', 'scarf', 'stopwatch', 'stove', 'strainer', 'tram', 'stretcher', 'couch', 'stupa', 'submarine', 'suit', 'sundial', 'sunglass', 'sunglasses', 'sunscreen', 'suspension bridge', 'mop', 'sweatshirt', 'swimsuit', 'swing', 'switch', 'syringe', 'table lamp', 'tape player', 'teapot', 'teddy bear', 'television', 'tennis ball', 'front curtain', 'thimble', 'throne', 'tile roof', 'toaster', 'tobacco shop', 'toilet seat', 'torch', 'totem pole', 'toy store', 'semi-trailer truck', 'tray', 'trench coat', 'tricycle', 'trimaran', 'tripod', 'trombone', 'tub', 'turnstile', 'typewriter keyboard', 'umbrella', 'unicycle', 'upright piano', 'vacuum cleaner', 'vase', 'vault', 'velvet', 'vending machine', 'vestment', 'violin', 'waffle iron', 'wall clock', 'wallet', 'wardrobe', 'military aircraft', 'sink', 'washing machine', 'water bottle', 'water jug', 'water tower', 'whiskey jug', 'whistle', 'wig', 'window screen', 'window shade', 'Windsor tie', 'wine bottle', 'wing', 'wok', 'wooden spoon', 'wool', 'split-rail fence', 'yawl', 'yurt', 'website', 'comic book', 'crossword', 'traffic sign', 'traffic light', 'dust jacket', 'menu', 'plate', 'consomme', 'hot pot', 'ice pop', 'pretzel', 'hot dog', 'cabbage', 'zucchini', 'butternut squash', 'cucumber', 'mushroom', 'orange', 'pineapple', 'banana', 'jackfruit', 'custard apple', 'chocolate syrup', 'dough', 'pizza', 'pot pie', 'burrito', 'red wine', 'espresso', 'cup', 'bubble', 'cliff', 'coral reef', 'geyser', 'lakeshore', 'promontory', 'shoal', 'seashore', 'valley', 'volcano', 'baseball player', 'bridegroom', 'scuba diver', "yellow lady's slipper", 'corn', 'coral fungus', 'agaric', 'gyromitra', 'earth star', 'hen-of-the-woods', 'bolete', 'toilet paper']
The prediction set is: []
The prediction set is: ['tennis ball']
The prediction set is: []
The prediction set is: ['jay', 'tick', 'grey parrot', 'macaw', 'slug', 'common gallinule', 'Pekingese', 'Shih Tzu', 'Papillon', 'West Highland White Terrier', 'Shetland Sheepdog', 'collie', 'rhinoceros beetle', 'dragonfly', 'damselfly', 'sea urchin', 'accordion', 'analog clock', 'backpack', 'ballpoint pen', 'Band-Aid', 'bassoon', 'beaker', 'bib', 'ring binder', 'bolo tie', 'bookcase', 'bookstore', 'bow', 'bow tie', 'broom', 'bucket', 'buckle', 'cauldron', 'candle', 'can opener', 'tool kit', 'carton', 'cassette', 'cassette player', 'CD player', 'mobile phone', 'chain', 'chime', 'Christmas stocking', 'cloak', 'coffee mug', 'coil', 'computer keyboard', 'croquet ball', 'crutch', 'desk', 'digital clock', 'digital watch', 'dishcloth', 'drum', 'drumstick', 'electric guitar', 'envelope', 'face powder', 'feather boa', 'filing cabinet', 'flute', 'fountain pen', 'grand piano', 'barrette', 'hair spray', 'hammer', 'hand-held computer', 'handkerchief', 'hard disk drive', 'harmonica', 'hook', 'iPod', 'jeans', 'jigsaw puzzle', 'knot', 'lab coat', 'ladle', 'laptop computer', 'lens cap', 'paper knife', 'library', 'lighter', 'lipstick', 'lotion', 'loupe', 'mail bag', 'maraca', 'marimba', 'mask', 'match', 'maypole', 'medicine chest', 'microphone', 'mitten', 'modem', 'square academic cap', 'computer mouse', 'nail', 'necklace', 'nipple', 'oboe', 'ocarina', 'oil filter', 'organ', 'oscilloscope', 'packet', 'paintbrush', 'pan flute', 'paper towel', 'pencil case', 'pencil sharpener', 'perfume', 'plectrum', 'pinwheel', 'plunger', 'pole', 'pot', 'printer', 'purse', 'quill', 'racket', 'radio', 'reel', 'remote control', 'revolver', 'rifle', 'eraser', 'ruler', 'safety pin', 'scabbard', 'screw', 'screwdriver', 'shovel', 'ski', 'slide rule', 'snorkel', 'sock', 'sombrero', 'soup bowl', 'spatula', 'spindle', 'steel drum', 'stethoscope', 'scarf', 'strainer', 'sunglass', 'sunglasses', 'sunscreen', 'mop', 'switch', 'syringe', 'tape player', 'tennis ball', 'thimble', 'torch', 'tray', 'tripod', 'umbrella', 'velvet', 'violin', 'wall clock', 'wallet', 'water bottle', 'whistle', 'wig', 'wooden spoon', 'wool', 'comic book', 'crossword', 'dust jacket', 'ice pop', 'toilet paper']
The prediction set is: ['grey parrot', 'macaw', 'lorikeet']</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-51-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-51-output-4.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-51-output-5.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-51-output-6.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-51-output-7.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-51-output-8.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-51-output-9.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-51-output-10.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-04-25-cp_files/figure-html/cell-51-output-11.png" class="img-fluid"></p>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>